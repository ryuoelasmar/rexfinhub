{% extends "base.html" %}
{% block title %}ETP Filing Tracker - Dashboard{% endblock %}

{% block content %}
<div class="header">
  <h1>ETP Filing Tracker</h1>
  <div class="date">{{ today.strftime('%B %d, %Y') }} &middot; {{ trusts|length }} trusts monitored</div>
</div>

{% if added %}
<div class="alert alert-success" style="display:flex; justify-content:space-between; align-items:center;">
  <span><strong>{{ added }}</strong> has been added to monitoring. Filing data will appear after the next pipeline run.</span>
  <a href="/" style="color:#155724; font-weight:600;">Dismiss</a>
</div>
{% endif %}

<!-- KPIs -->
<div class="kpi-row">
  <div class="kpi">
    <div class="num">{{ trusts|length }}</div>
    <div class="label">Trusts</div>
  </div>
  <div class="kpi">
    <div class="num">{{ total_funds }}</div>
    <div class="label">Total Funds</div>
  </div>
  <div class="kpi kpi-green">
    <div class="num">{{ total_effective }}</div>
    <div class="label">Effective</div>
  </div>
  <div class="kpi kpi-orange">
    <div class="num">{{ total_pending }}</div>
    <div class="label">Pending</div>
  </div>
  <div class="kpi kpi-red">
    <div class="num">{{ total_delayed }}</div>
    <div class="label">Delayed</div>
  </div>
</div>

<!-- Recent Filings -->
<div class="section-header">
  <h2>Recent Filings</h2>
  <span class="badge">{{ recent_filings|length }}</span>
</div>
<form method="get" action="/" style="margin-bottom:12px;">
  <div class="filter-bar" style="border-radius:8px;">
    <select name="days" style="padding:6px 12px; border:1px solid var(--border); border-radius:4px; font-size:13px;">
      {% for d, label in [(7,'7 days'),(14,'14 days'),(30,'30 days'),(90,'90 days'),(0,'All time')] %}
      <option value="{{ d }}" {% if days == d %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="form_type" style="padding:6px 12px; border:1px solid var(--border); border-radius:4px; font-size:13px;">
      <option value="">All Forms</option>
      {% for ft in ['485BPOS','485BXT','485APOS','497'] %}
      <option value="{{ ft }}" {% if form_type == ft %}selected{% endif %}>{{ ft }}</option>
      {% endfor %}
    </select>
    <select name="filing_trust_id" style="padding:6px 12px; border:1px solid var(--border); border-radius:4px; font-size:13px;">
      <option value="0">All Trusts</option>
      {% for t in filing_trusts %}
      <option value="{{ t.id }}" {% if filing_trust_id == t.id %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
  </div>
</form>

{% if recent_filings %}
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Form</th>
      <th>Trust</th>
      <th>Fund(s)</th>
      <th>Doc</th>
      <th>AI</th>
    </tr>
  </thead>
  <tbody>
    {% for row in recent_filings %}
    {% set f = row.Filing %}
    <tr>
      <td>{{ f.filing_date or '' }}</td>
      <td>{{ f.form }}</td>
      <td><a href="/trusts/{{ row.trust_slug }}">{{ row.trust_name }}</a></td>
      <td style="font-size:12px; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ row.fund_names or '' }}</td>
      <td>
        {% if f.primary_link %}
        <a href="{{ f.primary_link }}" target="_blank">View</a>
        {% endif %}
      </td>
      <td><a href="/analysis/filing/{{ f.id }}" class="btn btn-sm" style="font-size:11px;">Analyze</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div style="text-align:center; padding:20px; color:var(--muted); font-size:13px;">
  {% if form_type or filing_trust_id or days != 7 %}
  No filings match the selected filters.
  {% else %}
  No recent filings in the last 7 days.
  {% endif %}
</div>
{% endif %}

<!-- All Trusts (Card Grid) -->
<div class="section-header" style="margin-top:30px;">
  <h2>Monitored Trusts</h2>
  <div style="display:flex; align-items:center; gap:8px;">
    <span class="badge">{{ trusts|length }}</span>
    <a href="/search/" class="btn btn-primary btn-sm">+ Request a Trust</a>
  </div>
</div>

<div class="trust-grid-loading" id="trust-grid-wrapper">
<!-- Skeleton placeholder cards -->
<div class="trust-grid-skeleton">
  {% for _ in range(12) %}
  <div class="skeleton-card">
    <div class="skeleton-row" style="margin-bottom:12px;">
      <div class="skeleton-circle"></div>
      <div style="flex:1;">
        <div class="skeleton-bar skeleton-bar-lg"></div>
        <div class="skeleton-bar skeleton-bar-sm"></div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
<!-- Real trust cards -->
<div class="trust-grid trust-grid-real">
  {% set monogram_colors = ['#1565C0','#2E7D32','#6A1B9A','#C62828','#00838F','#4527A0','#AD1457','#EF6C00','#283593','#00695C','#37474F','#5D4037'] %}
  {% for t in trusts %}
  <a href="/trusts/{{ t.slug }}" class="trust-card">
    <div class="trust-card-header">
      <div class="trust-monogram" style="background:{{ monogram_colors[loop.index0 % monogram_colors|length] }};">
        {{ t.name.split()[0][0] }}{{ t.name.split()[1][0] if t.name.split()|length > 1 else '' }}
      </div>
      <div>
        <h3>{{ t.name }}</h3>
        {% if t.is_rex %}<span class="rex-badge">[REX]</span>{% endif %}
      </div>
    </div>
    {% if t.total == 0 %}
      {% if t.act_type == '33' %}
      <div class="trust-card-pending" style="color:var(--blue);">
        33 Act Filer - N-1A <span>(S-1 / 10-K registration)</span>
      </div>
      {% elif t.filing_count > 0 %}
      <div class="trust-card-pending">
        No 485 filings found <span>(S-1 / 10-K filer)</span>
      </div>
      {% else %}
      <div class="trust-card-pending">
        Pipeline pending... <span>data appears after next run</span>
      </div>
      {% endif %}
    {% else %}
    <div class="trust-card-stats">
      <span class="trust-stat"><strong>{{ t.total }}</strong> funds</span>
      <span class="trust-stat trust-stat-green"><strong>{{ t.effective }}</strong> eff</span>
      <span class="trust-stat trust-stat-orange"><strong>{{ t.pending }}</strong> pend</span>
      {% if t.delayed > 0 %}
      <span class="trust-stat trust-stat-red"><strong>{{ t.delayed }}</strong> del</span>
      {% endif %}
    </div>
    {% endif %}
  </a>
  {% endfor %}
</div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Reveal trust cards once the page has finished rendering
(function() {
  var wrapper = document.getElementById('trust-grid-wrapper');
  if (!wrapper) return;
  function reveal() {
    wrapper.classList.remove('trust-grid-loading');
  }
  if (document.readyState === 'complete') { reveal(); }
  else { window.addEventListener('load', reveal); }
})();
</script>
{% endblock %}
