{% set active_tab = 'share' %}
{% extends "market/base.html" %}

{% block title %}Issuer Market Share — REX Financial Intelligence Hub{% endblock %}

{% block market_content %}
<h2 class="section-title">Issuer Market Share</h2>

<!-- Category Selector -->
<div style="margin-bottom:20px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
  <label style="font-size:0.8rem; font-weight:600; color:#475569;">Category:</label>
  <select class="select-sm" onchange="location.href='/market/share?cat='+this.value" style="min-width:250px; padding:6px 10px; border:1px solid #E2E8F0; border-radius:6px; font-size:0.85rem;">
    {% for c in all_categories %}
    <option value="{{ c }}" {% if c == cat %}selected{% endif %}>
      {{ c | replace('Leverage & Inverse - ','L&I ') | replace('Income - ','Inc ') }}
    </option>
    {% endfor %}
  </select>
  {% if data_as_of %}<span style="font-size:0.72rem; color:#94A3B8;">Data as of {{ data_as_of }}</span>{% endif %}
</div>

{% if not available %}
<div class="alert alert-info">Market data not available.</div>
{% elif not share_data or not share_data.issuers %}
<div class="alert alert-warning">No issuer data for this category.</div>
{% else %}

<!-- KPI Bar -->
<div style="display:flex; gap:24px; margin-bottom:20px; flex-wrap:wrap;">
  <div>
    <span style="font-size:1.2rem; font-weight:800;">{{ share_data.total_aum_fmt }}</span>
    <span style="font-size:0.72rem; color:#94A3B8; text-transform:uppercase; margin-left:6px;">Total AUM</span>
  </div>
  <div>
    <span style="font-size:1.2rem; font-weight:800;">{{ share_data.issuers|length }}</span>
    <span style="font-size:0.72rem; color:#94A3B8; text-transform:uppercase; margin-left:6px;">Issuers</span>
  </div>
</div>

<div class="charts-row">
  <!-- Donut Chart -->
  <div class="chart-box">
    <h3>Share by Issuer (Top 10 by AUM)</h3>
    <canvas id="issuerShareDonut" height="240"></canvas>
  </div>

  <!-- 12-month Trend -->
  {% if share_data.trend and share_data.trend.months %}
  <div class="chart-box">
    <h3>AUM Trend — Top 5 Issuers (12 Months)</h3>
    <canvas id="issuerTrendChart" height="240"></canvas>
  </div>
  {% endif %}
</div>

<!-- Bar Chart -->
<div class="chart-box" style="margin-top:16px;">
  <h3>AUM by Issuer</h3>
  <canvas id="issuerBarChart" height="200"></canvas>
</div>

<!-- Issuer Table -->
<div class="chart-box" style="margin-top:16px;">
  <h3>All Issuers in {{ cat | replace('Leverage & Inverse - ','L&I ') | replace('Income - ','Inc ') }}</h3>
  <div class="table-responsive">
    <table class="data-table" id="issuerShareTable">
      <thead>
        <tr>
          <th onclick="sortTable('issuerShareTable',0)">#</th>
          <th onclick="sortTable('issuerShareTable',1)">Issuer</th>
          <th onclick="sortTable('issuerShareTable',2)">AUM</th>
          <th onclick="sortTable('issuerShareTable',3)">Share %</th>
          <th onclick="sortTable('issuerShareTable',4)">Products</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody>
        {% for issuer in share_data.issuers %}
        <tr class="{{ 'rex-highlight' if issuer.is_rex else '' }}">
          <td style="color:#94A3B8; font-size:0.8rem;">{{ loop.index }}</td>
          <td>
            {{ issuer.name }}
            {% if issuer.is_rex %}<span style="color:#1E40AF;font-size:0.7rem;font-weight:700;margin-left:4px;">REX</span>{% endif %}
          </td>
          <td class="num-cell">{{ issuer.aum_fmt }}</td>
          <td class="num-cell">{{ "%.1f%%"|format(issuer.pct) }}</td>
          <td class="num-cell">{{ issuer.num_products }}</td>
          <td><a href="/market/issuer/detail?issuer={{ issuer.name|urlencode }}" class="btn btn-sm" style="font-size:0.7rem; padding:2px 6px;">&rarr;</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endif %}
{% endblock %}

{% block market_scripts %}
{% if share_data and share_data.issuers %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var shareIssuers = {{ share_data.issuers | tojson }};
  var top10 = shareIssuers.slice(0, 10);

  // Donut chart
  MarketCharts.renderPieChart('issuerShareDonut',
    top10.map(function(i){return i.name;}),
    top10.map(function(i){return i.aum;})
  );

  // Bar chart
  MarketCharts.renderBarChart('issuerBarChart',
    top10.map(function(i){return i.name;}),
    top10.map(function(i){return i.aum;}),
    top10.map(function(i){return i.is_rex;})
  );

  {% if share_data.trend and share_data.trend.months %}
  var trendData = {{ share_data.trend | tojson }};
  var colors = ['#1E40AF','#059669','#D97706','#7C3AED','#E11D48'];
  MarketCharts.renderLineChart('issuerTrendChart', trendData.months,
    trendData.series.map(function(s, idx) {
      return {
        label: s.issuer,
        data: s.values,
        color: colors[idx % colors.length],
      };
    })
  );
  {% endif %}
});
</script>
{% endif %}
{% endblock %}
