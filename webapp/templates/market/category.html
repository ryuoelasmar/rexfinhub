{% set active_tab = 'category' %}
{% extends "market/base.html" %}

{% block title %}Category View — REX Financial Intelligence Hub{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2"></script>
{% endblock %}

{% block market_content %}
<div id="market-category-page" data-category="{{ category if category and category != 'All' else '' }}">

{# Category Pills (no "All" pill) #}
<div class="category-pills" id="catPills">
  {% for c in categories %}
  <a href="/market/category?cat={{ c|urlencode }}&fund_structure={{ fund_structure|default('ETF') }}"
     class="pill {% if category == c %}active{% endif %}"
     title="{{ c }}">
    {{ c | replace('Leverage & Inverse - ', 'L&I ') | replace('Income - ', 'Inc ') | truncate(28, true) }}
  </a>
  {% endfor %}
</div>

{# ETF/ETN Filter Toggle #}
{% if fund_structure is defined %}
<div class="filter-bar" style="display:flex; gap:8px; margin-bottom:16px; align-items:center;">
  <span style="font-size:0.75rem; color:#94A3B8; font-weight:600; text-transform:uppercase;">Structure:</span>
  <a href="?cat={{ category|default('All')|urlencode }}&fund_structure=ETF"
     class="pill {% if fund_structure == 'ETF' %}active{% endif %}">ETF</a>
  <a href="?cat={{ category|default('All')|urlencode }}&fund_structure=ETN"
     class="pill {% if fund_structure == 'ETN' %}active{% endif %}">ETN</a>
  <a href="?cat={{ category|default('All')|urlencode }}&fund_structure=ETF,ETN"
     class="pill {% if fund_structure == 'ETF,ETN' %}active{% endif %}">Both</a>
</div>
{% endif %}

{# Dynamic Slicer Panel #}
<div id="slicerPanel" class="slicer-panel" {% if not slicers %}style="display:none"{% endif %}>
  {% for slicer in slicers %}
  <div class="slicer-group" data-field="{{ slicer.field }}">
    <label>{{ slicer.label }}:</label>
    <select class="slicer-select select-sm" data-field="{{ slicer.field }}" onchange="MarketFilters.applyFilters()">
      <option value="">All</option>
      {% for opt in slicer.options %}
      {% set is_selected = active_filters is defined and active_filters and slicer.field in active_filters and active_filters[slicer.field] == opt %}
      <option value="{{ opt }}" {% if is_selected %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </div>
  {% endfor %}
</div>

{% if summary %}
{# Split KPI Cards #}
<div class="kpi-split">
  <div class="kpi-split-section">
    <h3 class="kpi-split-title">Category Totals</h3>
    {% with kpis=summary.cat_kpis, prefix='cat-' %}
    {% include "market/_kpi_cards.html" %}
    {% endwith %}
  </div>
  <div class="kpi-split-section rex-section">
    <h3 class="kpi-split-title">REX in this Category</h3>
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">REX AUM</div>
        <div class="kpi-value" id="cat-rex-aum">{{ summary.rex_kpis.aum_fmt }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Market Share</div>
        <div class="kpi-value" id="cat-rex-share">{{ summary.rex_share }}%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">REX Products</div>
        <div class="kpi-value" id="cat-rex-count">{{ summary.rex_kpis.num_products }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">1W Flows</div>
        <div class="kpi-value {{ 'positive' if summary.rex_kpis.flow_1w > 0 else 'negative' if summary.rex_kpis.flow_1w < 0 else '' }}" id="cat-rex-flow1w">{{ summary.rex_kpis.flow_1w_fmt }}</div>
      </div>
    </div>
  </div>
</div>

{# Charts Row #}
<div class="charts-row">
  <div class="chart-box">
    <h3>Market Share by Issuer</h3>
    <canvas id="issuerBarChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Category AUM Trend</h3>
    <canvas id="categoryTrendChart"></canvas>
  </div>
</div>

{# Treemap Section #}
{% if treemap is defined and treemap and treemap.issuers %}
<div class="chart-box" style="margin-bottom:24px;">
  <h3>Market Landscape — {{ category or 'All Categories' }}</h3>
  <div class="treemap-container">
    <canvas id="categoryTreemap"></canvas>
  </div>
  {% if treemap.issuers %}
  <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; font-size:0.72rem;">
    {% set treemap_colors = ['#1E40AF','#DC2626','#059669','#D97706','#7C3AED','#DB2777','#0891B2','#65A30D','#6366F1','#F43F5E','#0D9488','#A855F7'] %}
    {% for iss in treemap.issuers %}
    <span style="display:inline-flex; align-items:center; gap:4px;">
      <span style="width:10px; height:10px; border-radius:2px; background:{{ treemap_colors[loop.index0 % treemap_colors|length] }};"></span>
      {{ iss.issuer }} ({{ iss.pct }}%)
    </span>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

{# All Products in Category #}
<h2 class="section-title">All Products in {{ category or 'All Categories' }}</h2>
<div class="table-controls" style="margin-bottom:12px;">
  <input type="text" id="productSearch" placeholder="Search ticker or name..." oninput="filterCatProducts(this.value)" style="padding:6px 12px; font-size:0.85rem; border:1px solid var(--border); border-radius:var(--radius-md); background:var(--card-bg, #fff); color:var(--text-primary);">
  <span class="filter-count" id="productCount">{{ summary.total_funds }} products</span>
</div>

{# REX Products Section (collapsible, open by default) #}
{% if summary.rex_products %}
<div class="collapsible-section" style="margin-bottom:16px;">
  <div class="section-header" onclick="toggleSection('rexSection')" style="cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(30,64,175,0.05); border:1px solid rgba(30,64,175,0.15); border-radius:var(--radius-md) var(--radius-md) 0 0;">
    <span class="expand-icon" id="rexSectionIcon">&#9660;</span>
    <span style="font-weight:600; color:#1E40AF; font-size:0.85rem;">REX Products ({{ summary.rex_products|length }})</span>
  </div>
  <div id="rexSection" class="section-body">
    <div class="table-responsive">
      <table class="data-table" id="rexProducts" style="border-top:none; border-radius:0 0 var(--radius-md) var(--radius-md);">
        <thead>
          <tr>
            <th>#</th>
            <th>Ticker</th>
            <th>Fund Name</th>
            <th>AUM</th>
            <th>1W Flow</th>
            <th>1M Flow</th>
            <th>Yield</th>
          </tr>
        </thead>
        <tbody>
          {% for p in summary.rex_products %}
          <tr class="rex-highlight cat-product-row" data-name="{{ p.fund_name|lower }}" data-ticker="{{ p.ticker|lower }}">
            <td>{{ p.rank if p.rank else '-' }}</td>
            <td class="ticker-col">{{ p.ticker }}</td>
            <td class="name-cell" title="{{ p.fund_name }}">{{ p.fund_name|truncate(45, true) }}</td>
            <td class="num-cell">{{ p.aum_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1w > 0 else 'negative' if p.flow_1w < 0 else '' }}">{{ p.flow_1w_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1m > 0 else 'negative' if p.flow_1m < 0 else '' }}">{{ p.flow_1m_fmt }}</td>
            <td class="num-cell">{{ p.yield_fmt if p.yield_fmt else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{# All Other Products Section (collapsible, open by default) #}
{% if summary.top_products %}
<div class="collapsible-section">
  <div class="section-header" onclick="toggleSection('allSection')" style="cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--surface-2); border:1px solid var(--border); border-radius:var(--radius-md) var(--radius-md) 0 0;">
    <span class="expand-icon" id="allSectionIcon">&#9660;</span>
    <span style="font-weight:600; font-size:0.85rem;">All Products ({{ summary.total_funds }})</span>
  </div>
  <div id="allSection" class="section-body">
    <div class="table-responsive">
      <table class="data-table" id="topProducts" style="border-top:none; border-radius:0 0 var(--radius-md) var(--radius-md);">
        <thead>
          <tr>
            <th>#</th>
            <th>Ticker</th>
            <th>Fund Name</th>
            <th>Issuer</th>
            <th>AUM</th>
            <th>1W Flow</th>
            <th>1M Flow</th>
            <th>Yield</th>
          </tr>
        </thead>
        <tbody>
          {% for p in summary.top_products %}
          <tr class="{{ 'rex-highlight' if p.is_rex else '' }} cat-product-row" data-name="{{ p.fund_name|lower }}" data-ticker="{{ p.ticker|lower }}">
            <td>{{ p.rank }}</td>
            <td class="ticker-col">{{ p.ticker }}</td>
            <td class="name-cell" title="{{ p.fund_name }}">{{ p.fund_name|truncate(40, true) }}</td>
            <td style="font-size:0.8rem; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ p.issuer }}</td>
            <td class="num-cell">{{ p.aum_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1w > 0 else 'negative' if p.flow_1w < 0 else '' }}">{{ p.flow_1w_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1m > 0 else 'negative' if p.flow_1m < 0 else '' }}">{{ p.flow_1m_fmt }}</td>
            <td class="num-cell">{{ p.yield_fmt if p.yield_fmt else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Pagination #}
    {% if summary.total_pages is defined and summary.total_pages > 1 %}
    <div class="pagination-controls" style="display:flex; align-items:center; justify-content:center; gap:8px; margin-top:16px; font-size:0.85rem;">
      {% set base_url = '/market/category?cat=' ~ (category|default('All')|urlencode) ~ '&fund_structure=' ~ (fund_structure|default('ETF')) %}
      {% if page > 1 %}
      <a href="{{ base_url }}&page={{ page - 1 }}&per_page={{ per_page }}" class="btn btn-sm" style="padding:4px 10px;">&laquo; Prev</a>
      {% endif %}
      <span style="color:var(--text-secondary);">Page {{ page }} of {{ summary.total_pages }} ({{ summary.total_funds }} products)</span>
      {% if page < summary.total_pages %}
      <a href="{{ base_url }}&page={{ page + 1 }}&per_page={{ per_page }}" class="btn btn-sm" style="padding:4px 10px;">Next &raquo;</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-warning">No data available for this category.</div>
{% endif %}

</div>{# end market-category-page #}
{% endblock %}

{% block market_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if summary %}
  // Bar chart - issuer market share
  var issuerData = {{ summary.issuer_data|tojson }};
  MarketCharts.renderBarChart('issuerBarChart', issuerData.labels, issuerData.values, issuerData.is_rex);
  {% endif %}

  {% if trend %}
  // Line chart - category AUM trend
  var trendData = {{ trend|tojson }};
  var datasets = [
    {label: 'Category AUM', data: trendData.total_values, color: '#6B7280'}
  ];
  if (trendData.rex_values && trendData.rex_values.some(function(v) { return v > 0; })) {
    datasets.push({label: 'REX AUM', data: trendData.rex_values, color: '#1E40AF'});
  }
  MarketCharts.renderLineChart('categoryTrendChart', trendData.labels, datasets);
  {% endif %}

  {% if treemap is defined and treemap and treemap.products %}
  // Treemap - individual products grouped by issuer
  var treemapProducts = {{ treemap.products|tojson }};
  MarketCharts.renderTreemap('categoryTreemap', treemapProducts);
  {% endif %}
});

function toggleSection(id) {
  var body = document.getElementById(id);
  var icon = document.getElementById(id + 'Icon');
  if (!body) return;
  if (body.style.display === 'none') {
    body.style.display = '';
    if (icon) icon.innerHTML = '&#9660;';
  } else {
    body.style.display = 'none';
    if (icon) icon.innerHTML = '&#9654;';
  }
}

function filterCatProducts(q) {
  q = (q || '').toLowerCase();
  var rows = document.querySelectorAll('.cat-product-row');
  var shown = 0;
  rows.forEach(function(row) {
    var name = row.getAttribute('data-name') || '';
    var ticker = row.getAttribute('data-ticker') || '';
    if (!q || name.indexOf(q) >= 0 || ticker.indexOf(q) >= 0) {
      row.style.display = '';
      shown++;
    } else {
      row.style.display = 'none';
    }
  });
  var countEl = document.getElementById('productCount');
  if (countEl) countEl.textContent = shown + ' products';
}
</script>
{% endblock %}
