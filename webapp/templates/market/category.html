{% set active_tab = 'category' %}
{% extends "market/base.html" %}

{% block title %}Category View — REX Financial Intelligence Hub{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2"></script>
{% endblock %}

{% block market_content %}
<div id="market-category-page" data-category="{{ category if category and category != 'All' else '' }}">

{# Category Pills (no "All" pill) #}
<div class="category-pills" id="catPills">
  {% for c in categories %}
  <a href="/market/category?cat={{ c|urlencode }}&fund_structure={{ fund_structure|default('ETF') }}"
     class="pill {% if category == c %}active{% endif %}"
     title="{{ c }}">
    {{ c | replace('Leverage & Inverse - ', 'L&I ') | replace('Income - ', 'Inc ') | truncate(28, true) }}
  </a>
  {% endfor %}
</div>

{# ETF/ETN Filter Toggle #}
{% if fund_structure is defined %}
<div class="filter-bar" style="display:flex; gap:8px; margin-bottom:16px; align-items:center;">
  <span style="font-size:0.75rem; color:#94A3B8; font-weight:600; text-transform:uppercase;">Structure:</span>
  <a href="?cat={{ category|default('All')|urlencode }}&fund_structure=ETF"
     class="pill {% if fund_structure == 'ETF' %}active{% endif %}">ETF</a>
  <a href="?cat={{ category|default('All')|urlencode }}&fund_structure=ETN"
     class="pill {% if fund_structure == 'ETN' %}active{% endif %}">ETN</a>
  <a href="?cat={{ category|default('All')|urlencode }}&fund_structure=ETF,ETN"
     class="pill {% if fund_structure == 'ETF,ETN' %}active{% endif %}">Both</a>
</div>
{% endif %}

{# Dynamic Slicer Panel #}
<div id="slicerPanel" class="slicer-panel" {% if not slicers %}style="display:none"{% endif %}>
  {% for slicer in slicers %}
  <div class="slicer-group" data-field="{{ slicer.field }}">
    <label>{{ slicer.label }}:</label>
    <select class="slicer-select select-sm" data-field="{{ slicer.field }}" onchange="MarketFilters.applyFilters()">
      <option value="">All</option>
      {% for opt in slicer.options %}
      {% set is_selected = active_filters is defined and active_filters and slicer.field in active_filters and active_filters[slicer.field] == opt %}
      <option value="{{ opt }}" {% if is_selected %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </div>
  {% endfor %}
</div>

{% if summary %}
{# Split KPI Cards #}
<div class="kpi-split">
  <div class="kpi-split-section">
    <h3 class="kpi-split-title">Category Totals</h3>
    {% with kpis=summary.cat_kpis, prefix='cat-' %}
    {% include "market/_kpi_cards.html" %}
    {% endwith %}
  </div>
  <div class="kpi-split-section rex-section">
    <h3 class="kpi-split-title">REX in this Category</h3>
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">REX AUM</div>
        <div class="kpi-value" id="cat-rex-aum">{{ summary.rex_kpis.aum_fmt }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Market Share</div>
        <div class="kpi-value" id="cat-rex-share">{{ summary.rex_share }}%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">REX Products</div>
        <div class="kpi-value" id="cat-rex-count">{{ summary.rex_kpis.num_products }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">1W Flows</div>
        <div class="kpi-value {{ 'positive' if summary.rex_kpis.flow_1w > 0 else 'negative' if summary.rex_kpis.flow_1w < 0 else '' }}" id="cat-rex-flow1w">{{ summary.rex_kpis.flow_1w_fmt }}</div>
      </div>
    </div>
  </div>
</div>

{# Charts Row #}
<div class="charts-row">
  <div class="chart-box">
    <h3>Market Share by Issuer</h3>
    <canvas id="issuerBarChart"></canvas>
  </div>
  <div class="chart-box" style="min-height:260px;">
    <div style="display:flex; gap:4px; margin-bottom:12px; flex-wrap:wrap;">
      <button class="pill chart-mode-btn active" data-mode="aum" onclick="switchCatChartMode('aum')">AUM</button>
      <button class="pill chart-mode-btn" data-mode="flows" onclick="switchCatChartMode('flows')">Flows</button>
      <button class="pill chart-mode-btn" data-mode="volume" onclick="switchCatChartMode('volume')">Volume</button>
      <button class="pill chart-mode-btn" data-mode="spread" onclick="switchCatChartMode('spread')">Bid-Ask</button>
      <button class="pill chart-mode-btn" data-mode="appreciation" onclick="switchCatChartMode('appreciation')">Mkt Appr</button>
    </div>
    <div id="catAumControls" style="margin-bottom:8px;">
      <label style="font-size:0.82rem; cursor:pointer;">
        <input type="checkbox" id="showIssuerBreakdown" onchange="switchCatChartMode('aum')"> Show Issuer Breakdown
      </label>
    </div>
    <div id="catFlowControls" style="display:none; margin-bottom:8px;">
      <button class="pill cat-flow-btn active" data-period="1w" onclick="showCatFlowPeriod('1w')">1W</button>
      <button class="pill cat-flow-btn" data-period="1m" onclick="showCatFlowPeriod('1m')">1M</button>
      <button class="pill cat-flow-btn" data-period="3m" onclick="showCatFlowPeriod('3m')">3M</button>
      <button class="pill cat-flow-btn" data-period="6m" onclick="showCatFlowPeriod('6m')">6M</button>
      <button class="pill cat-flow-btn" data-period="ytd" onclick="showCatFlowPeriod('ytd')">YTD</button>
      <button class="pill cat-flow-btn" data-period="1y" onclick="showCatFlowPeriod('1y')">1Y</button>
    </div>
    <canvas id="catUnifiedChart" height="200"></canvas>
  </div>
</div>

{# Treemap Section #}
{% if treemap is defined and treemap and treemap.issuers %}
<div class="chart-box" style="margin-bottom:12px; padding:16px; padding-bottom:0;">
  <h3 style="margin-bottom:8px;">Market Landscape — {{ category or 'All Categories' }}</h3>
  <canvas id="categoryTreemap" style="max-height:450px;"></canvas>
</div>
{% endif %}

{# All Products in Category #}
<h2 class="section-title">All Products in {{ category or 'All Categories' }}</h2>
<div class="table-controls" style="margin-bottom:12px;">
  <input type="text" id="productSearch" placeholder="Search ticker or name..." oninput="filterCatProducts(this.value)" style="padding:6px 12px; font-size:0.85rem; border:1px solid var(--border); border-radius:var(--radius-md); background:var(--card-bg, #fff); color:var(--text-primary);">
  <span class="filter-count" id="productCount">{{ summary.total_funds }} products</span>
</div>

{# REX Products Section (collapsible, open by default) #}
{% if summary.rex_products %}
<div class="collapsible-section" style="margin-bottom:16px;">
  <div class="section-header" onclick="toggleSection('rexSection')" style="cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(30,64,175,0.05); border:1px solid rgba(30,64,175,0.15); border-radius:var(--radius-md) var(--radius-md) 0 0;">
    <span class="expand-icon" id="rexSectionIcon">&#9660;</span>
    <span style="font-weight:600; color:#1E40AF; font-size:0.85rem;">REX Products ({{ summary.rex_products|length }})</span>
  </div>
  <div id="rexSection" class="section-body">
    <div class="table-responsive">
      <table class="data-table" id="rexProducts" style="border-top:none; border-radius:0 0 var(--radius-md) var(--radius-md);">
        <thead>
          <tr>
            <th>#</th>
            <th>Ticker</th>
            <th>Fund Name</th>
            <th>AUM</th>
            <th>1W Flow</th>
            <th>1M Flow</th>
            <th>Yield</th>
          </tr>
        </thead>
        <tbody>
          {% for p in summary.rex_products %}
          <tr class="rex-highlight cat-product-row" data-name="{{ p.fund_name|lower }}" data-ticker="{{ p.ticker|lower }}">
            <td>{{ p.rank if p.rank else '-' }}</td>
            <td class="ticker-col">{{ p.ticker }}</td>
            <td class="name-cell" title="{{ p.fund_name }}">{{ p.fund_name|truncate(45, true) }}</td>
            <td class="num-cell">{{ p.aum_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1w > 0 else 'negative' if p.flow_1w < 0 else '' }}">{{ p.flow_1w_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1m > 0 else 'negative' if p.flow_1m < 0 else '' }}">{{ p.flow_1m_fmt }}</td>
            <td class="num-cell">{{ p.yield_fmt if p.yield_fmt else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{# All Other Products Section (collapsible, open by default) #}
{% if summary.top_products %}
<div class="collapsible-section">
  <div class="section-header" onclick="toggleSection('allSection')" style="cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--surface-2); border:1px solid var(--border); border-radius:var(--radius-md) var(--radius-md) 0 0;">
    <span class="expand-icon" id="allSectionIcon">&#9660;</span>
    <span style="font-weight:600; font-size:0.85rem;">All Products ({{ summary.total_funds }})</span>
  </div>
  <div id="allSection" class="section-body">
    <div class="table-responsive">
      <table class="data-table" id="topProducts" style="border-top:none; border-radius:0 0 var(--radius-md) var(--radius-md);">
        <thead>
          <tr>
            <th>#</th>
            <th>Ticker</th>
            <th>Fund Name</th>
            <th>Issuer</th>
            <th>AUM</th>
            <th>1W Flow</th>
            <th>1M Flow</th>
            <th>Yield</th>
          </tr>
        </thead>
        <tbody>
          {% for p in summary.top_products %}
          <tr class="{{ 'rex-highlight' if p.is_rex else '' }} cat-product-row" data-name="{{ p.fund_name|lower }}" data-ticker="{{ p.ticker|lower }}">
            <td>{{ p.rank }}</td>
            <td class="ticker-col">{{ p.ticker }}</td>
            <td class="name-cell" title="{{ p.fund_name }}">{{ p.fund_name|truncate(40, true) }}</td>
            <td style="font-size:0.8rem; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ p.issuer }}</td>
            <td class="num-cell">{{ p.aum_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1w > 0 else 'negative' if p.flow_1w < 0 else '' }}">{{ p.flow_1w_fmt }}</td>
            <td class="num-cell {{ 'positive' if p.flow_1m > 0 else 'negative' if p.flow_1m < 0 else '' }}">{{ p.flow_1m_fmt }}</td>
            <td class="num-cell">{{ p.yield_fmt if p.yield_fmt else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Pagination #}
    {% if summary.total_pages is defined and summary.total_pages > 1 %}
    <div class="pagination-bar">
      <span class="pagination-info">{{ summary.total_funds }} products &middot; page {{ page }} of {{ summary.total_pages }}</span>
      <div class="pagination-controls">
        {% if page > 1 %}
        <a href="?{{ base_qs }}&page={{ page - 1 }}" class="btn btn-sm">Prev</a>
        {% endif %}
        {% if summary.total_pages <= 7 %}
          {% for p in range(1, summary.total_pages + 1) %}
          <a href="?{{ base_qs }}&page={{ p }}" class="btn btn-sm {{ 'btn-primary' if p == page else '' }}">{{ p }}</a>
          {% endfor %}
        {% else %}
          {% for p in range(1, summary.total_pages + 1) %}
            {% if p == 1 or p == summary.total_pages or (p >= page - 2 and p <= page + 2) %}
              {% if prev_shown is defined and p > prev_shown + 1 %}
              <span style="color:var(--text-muted); padding:0 4px;">&hellip;</span>
              {% endif %}
              <a href="?{{ base_qs }}&page={{ p }}" class="btn btn-sm {{ 'btn-primary' if p == page else '' }}">{{ p }}</a>
              {% set prev_shown = p %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if page < summary.total_pages %}
        <a href="?{{ base_qs }}&page={{ page + 1 }}" class="btn btn-sm">Next</a>
        {% endif %}
      </div>
      <select class="select-sm" onchange="location='?{{ base_qs }}&page=1&per_page='+this.value">
        {% for n in [25, 50, 100, 200] %}
        <option value="{{ n }}"{{ ' selected' if n == per_page else '' }}>{{ n }}/page</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-warning">No data available for this category.</div>
{% endif %}

</div>{# end market-category-page #}
{% endblock %}

{% block market_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if summary %}
  // Bar chart - issuer market share
  var issuerData = {{ summary.issuer_data|tojson }};
  MarketCharts.renderBarChart('issuerBarChart', issuerData.labels, issuerData.values, issuerData.is_rex);
  {% endif %}

  {% if trend %}
  // Unified chart data
  var catTrendData = {{ trend|tojson }};
  {% if summary and summary.chart_data is defined %}
  var catChartData = {{ summary.chart_data|tojson }};
  {% else %}
  var catChartData = {flow: {}, volume: {}, spread: {}, appreciation: {}};
  {% endif %}

  var _catUnifiedChart = null;
  var _catChartMode = 'aum';
  var _catFlowPeriod = '1w';

  function catFmtMoney(val) {
    if (val === null || val === undefined || isNaN(val)) return '$0';
    var sign = val < 0 ? '-' : '';
    var abs = Math.abs(val);
    if (abs >= 1000) return sign + '$' + (abs / 1000).toFixed(1) + 'B';
    if (abs >= 1) return sign + '$' + abs.toFixed(1) + 'M';
    return sign + '$' + (abs * 1000).toFixed(0) + 'K';
  }
  function catFmtFlow(val) { return (val >= 0 ? '+' : '') + catFmtMoney(val); }
  function catFmtVol(val) {
    if (val >= 1000000) return (val/1000000).toFixed(1) + 'M';
    if (val >= 1000) return Math.round(val/1000) + 'K';
    return Math.round(val).toString();
  }

  var ISSUER_COLORS = ['#1E40AF','#3B82F6','#0EA5E9','#6366F1','#8B5CF6','#A855F7','#EC4899','#F43F5E','#F97316','#EAB308','#22C55E','#14B8A6'];

  window.switchCatChartMode = function(mode) {
    _catChartMode = mode;
    document.querySelectorAll('.chart-mode-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-mode') === mode);
    });
    document.getElementById('catAumControls').style.display = mode === 'aum' ? '' : 'none';
    document.getElementById('catFlowControls').style.display = mode === 'flows' ? '' : 'none';

    if (_catUnifiedChart) { _catUnifiedChart.destroy(); _catUnifiedChart = null; }
    var ctx = document.getElementById('catUnifiedChart');
    if (!ctx) return;
    var isDark = RexTheme.isDark();
    var labelColor = isDark ? '#94a3b8' : '#6b7280';
    var gridColor = isDark ? 'rgba(255,255,255,0.08)' : '#f3f4f6';

    if (mode === 'aum') {
      var showBreakdown = document.getElementById('showIssuerBreakdown') && document.getElementById('showIssuerBreakdown').checked;
      var datasets = [];
      if (showBreakdown && catChartData.flow && catChartData.flow.issuers) {
        // Per-issuer AUM not available in time series - show category + REX lines
        datasets.push({
          label: 'Category AUM', data: catTrendData.total_values,
          borderColor: '#6B7280', backgroundColor: '#6B728020',
          fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2
        });
        if (catTrendData.rex_values && catTrendData.rex_values.some(function(v) { return v > 0; })) {
          datasets.push({
            label: 'REX AUM', data: catTrendData.rex_values,
            borderColor: '#1E40AF', backgroundColor: '#1E40AF20',
            fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2
          });
        }
      } else {
        datasets.push({
          label: 'Category AUM', data: catTrendData.total_values,
          borderColor: '#6B7280', backgroundColor: '#6B728020',
          fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2
        });
        if (catTrendData.rex_values && catTrendData.rex_values.some(function(v) { return v > 0; })) {
          datasets.push({
            label: 'REX AUM', data: catTrendData.rex_values,
            borderColor: '#1E40AF', backgroundColor: '#1E40AF20',
            fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2
          });
        }
      }
      _catUnifiedChart = new Chart(ctx, {
        type: 'line',
        data: { labels: catTrendData.labels, datasets: datasets },
        options: {
          responsive: true, maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 12, font: { size: 10 }, color: labelColor }, grid: { display: false } },
            y: { ticks: { callback: function(v) { return catFmtMoney(v); }, font: { size: 10 }, color: labelColor }, grid: { color: gridColor } }
          },
          plugins: {
            datalabels: { display: false },
            legend: { display: datasets.length > 1, labels: { font: { size: 11 }, usePointStyle: true, color: labelColor } },
            tooltip: { callbacks: { label: function(c) { return c.dataset.label + ': ' + catFmtMoney(c.parsed.y); } } }
          }
        }
      });

    } else if (mode === 'flows') {
      showCatFlowPeriod(_catFlowPeriod);

    } else if (mode === 'volume') {
      var vd = catChartData.volume || {};
      _catUnifiedChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels: vd.issuers || [],
          datasets: [{ data: vd.values || [], backgroundColor: '#3B82F6', borderRadius: 3 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: true,
          layout: { padding: { right: 80 } },
          scales: {
            x: { display: false, grace: '15%' },
            y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(c) { return catFmtVol(c.parsed.x); } } },
            datalabels: {
              anchor: 'end', align: 'right',
              color: isDark ? '#e2e8f0' : '#1E293B',
              font: { size: 11, weight: '600' },
              formatter: function(v) { return catFmtVol(v); },
              clip: false
            }
          }
        }
      });

    } else if (mode === 'spread') {
      var sd = catChartData.spread || {};
      _catUnifiedChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels: sd.issuers || [],
          datasets: [{ data: sd.values || [], backgroundColor: '#6366F1', borderRadius: 3 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: true,
          layout: { padding: { right: 80 } },
          scales: {
            x: { display: false, grace: '15%' },
            y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(c) { return '$' + c.parsed.x.toFixed(4); } } },
            datalabels: {
              anchor: 'end', align: 'right',
              color: isDark ? '#e2e8f0' : '#1E293B',
              font: { size: 11, weight: '600' },
              formatter: function(v) { return '$' + v.toFixed(4); },
              clip: false
            }
          }
        }
      });

    } else if (mode === 'appreciation') {
      var ad = catChartData.appreciation || {};
      var vals = ad.values || [];
      var colors = vals.map(function(v) { return v >= 0 ? '#059669' : '#DC2626'; });
      _catUnifiedChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels: ad.issuers || [],
          datasets: [{ data: vals, backgroundColor: colors, borderRadius: 3 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: true,
          layout: { padding: { left: 10, right: 100 } },
          scales: {
            x: { display: false, grace: '20%' },
            y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(c) { return catFmtFlow(c.parsed.x); } } },
            datalabels: {
              anchor: 'end',
              align: function(c) { return c.dataset.data[c.dataIndex] >= 0 ? 'right' : 'left'; },
              color: isDark ? '#e2e8f0' : '#1E293B',
              font: { size: 11, weight: '600' },
              formatter: function(v) { return v === 0 ? '' : catFmtFlow(v); },
              clip: false
            }
          }
        }
      });
    }
  };

  window.showCatFlowPeriod = function(period) {
    _catFlowPeriod = period;
    document.querySelectorAll('.cat-flow-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-period') === period);
    });
    var flowData = catChartData.flow || {};
    var key = 'flow_' + period;
    var values = flowData[key];
    if (!values) return;
    var colors = values.map(function(v) { return v >= 0 ? '#059669' : '#DC2626'; });
    var isDark = RexTheme.isDark();
    var labelColor = isDark ? '#94a3b8' : '#374151';
    if (_catUnifiedChart) { _catUnifiedChart.destroy(); _catUnifiedChart = null; }
    _catUnifiedChart = new Chart(document.getElementById('catUnifiedChart').getContext('2d'), {
      type: 'bar',
      plugins: [ChartDataLabels],
      data: {
        labels: flowData.issuers,
        datasets: [{ label: 'Flow $M', data: values, backgroundColor: colors }]
      },
      options: {
        indexAxis: 'y',
        layout: { padding: { left: 10, right: 100 } },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: function(ctx) { return catFmtFlow(ctx.parsed.x); } } },
          datalabels: {
            anchor: 'end',
            align: function(ctx) { return ctx.dataset.data[ctx.dataIndex] >= 0 ? 'right' : 'left'; },
            color: isDark ? '#e2e8f0' : '#1E293B',
            font: { size: 11, weight: '600' },
            formatter: function(value) { return value === 0 ? '' : catFmtFlow(value); },
            clip: false
          }
        },
        scales: {
          x: { display: false, grace: '20%' },
          y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
        }
      }
    });
  };

  // Initialize with AUM mode
  switchCatChartMode('aum');
  {% endif %}

  {% if treemap is defined and treemap and treemap.products %}
  // Treemap - individual products grouped by issuer
  var treemapProducts = {{ treemap.products|tojson }};
  MarketCharts.renderTreemap('categoryTreemap', treemapProducts);
  {% endif %}
});

function toggleSection(id) {
  var body = document.getElementById(id);
  var icon = document.getElementById(id + 'Icon');
  if (!body) return;
  if (body.style.display === 'none') {
    body.style.display = '';
    if (icon) icon.innerHTML = '&#9660;';
  } else {
    body.style.display = 'none';
    if (icon) icon.innerHTML = '&#9654;';
  }
}

function filterCatProducts(q) {
  q = (q || '').toLowerCase();
  var rows = document.querySelectorAll('.cat-product-row');
  var shown = 0;
  rows.forEach(function(row) {
    var name = row.getAttribute('data-name') || '';
    var ticker = row.getAttribute('data-ticker') || '';
    if (!q || name.indexOf(q) >= 0 || ticker.indexOf(q) >= 0) {
      row.style.display = '';
      shown++;
    } else {
      row.style.display = 'none';
    }
  });
  var countEl = document.getElementById('productCount');
  if (countEl) countEl.textContent = shown + ' products';
}
</script>
{% endblock %}
