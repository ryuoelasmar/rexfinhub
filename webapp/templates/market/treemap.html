{% set active_tab = 'treemap' %}
{% extends "market/base.html" %}

{% block title %}Product Treemap — REX Financial Intelligence Hub{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3"></script>
{% endblock %}

{% block market_content %}
{# Category Filter — no "All" option #}
<div class="category-selector">
  <label for="catFilter">Category:</label>
  <select id="catFilter" onchange="window.location='/market/treemap?cat='+this.value">
    {% for c in categories %}
    <option value="{{ c }}" {% if c == category %}selected{% endif %}>
      {{ c | replace('Leverage & Inverse - ', 'L&I ') | replace('Income - ', 'Inc ') }}
    </option>
    {% endfor %}
  </select>
  {% if summary %}<span class="kpi-value">{{ summary.total_aum_fmt }} total AUM</span>{% endif %}
</div>

{% if not summary or not summary.products %}
<div style="text-align:center; padding:60px; color:#94A3B8;">
  <p style="font-size:1.1rem;">No products found for this category.</p>
  <p style="font-size:0.85rem;">Try selecting a different category.</p>
</div>
{% else %}
<div class="treemap-container">
  <canvas id="treemapChart"></canvas>
</div>

{# Issuer color legend #}
<div class="treemap-legend" style="margin-top:16px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
  {% set seen_issuers = [] %}
  {% for p in summary.products %}
    {% if p.issuer not in seen_issuers and seen_issuers|length < 8 %}
      {% set _ = seen_issuers.append(p.issuer) %}
    {% endif %}
  {% endfor %}
  <span style="font-size:0.72rem; color:#94A3B8; font-weight:600; text-transform:uppercase; margin-right:4px;">Issuers:</span>
  {% for issuer in seen_issuers %}
  <span class="treemap-legend-item" data-index="{{ loop.index0 }}" style="display:inline-flex; align-items:center; gap:4px; font-size:0.78rem; color:#475569;">
    <span class="treemap-legend-dot"></span>{{ issuer }}
  </span>
  {% endfor %}
</div>
<script>
var LEGEND_COLORS = ['#1E40AF','#059669','#7C3AED','#D97706','#0891B2','#E11D48','#65A30D','#9333EA'];
document.querySelectorAll('.treemap-legend-item').forEach(function(el) {
  var idx = parseInt(el.getAttribute('data-index'));
  var dot = el.querySelector('.treemap-legend-dot');
  if (dot) { dot.style.background = LEGEND_COLORS[idx % LEGEND_COLORS.length]; dot.style.display='inline-block'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.marginRight='4px'; }
});
</script>
{% endif %}
{% endblock %}

{% block market_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if summary and summary.products %}
  var products = {{ summary.products|tojson }};

  // Render treemap with issuer grouping and ticker labels
  var ctx = document.getElementById('treemapChart');
  if (ctx && products.length > 0) {
    var groupColors = {};
    var palette = ['#1E40AF','#DC2626','#059669','#D97706','#7C3AED','#DB2777','#0891B2','#65A30D'];
    var groups = [];
    products.forEach(function(p) {
      if (groups.indexOf(p.group) === -1) groups.push(p.group);
    });
    groups.forEach(function(g, i) { groupColors[g] = palette[i % palette.length]; });

    new Chart(ctx, {
      type: 'treemap',
      data: {
        datasets: [{
          label: 'AUM by Product',
          tree: products,
          key: 'value',
          groups: ['group'],
          backgroundColor: function(c) {
            if (!c.raw || !c.raw.g) return '#6B7280';
            var base = groupColors[c.raw.g] || '#6B7280';
            return c.raw._data && c.raw._data.is_rex ? base : base + '99';
          },
          captions: {
            display: true,
            color: '#1E293B',
            font: { size: 12, weight: 'bold' },
            align: 'left',
            padding: 4
          },
          labels: {
            display: true,
            formatter: function(c) {
              if (c.raw && c.raw._data) {
                return c.raw._data.label || c.raw._data.ticker || '';
              }
              return '';
            },
            color: '#ffffff',
            font: { size: 10 }
          }
        }]
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              title: function(items) { return items[0].raw._data ? items[0].raw._data.label : ''; },
              label: function(item) {
                var d = item.raw._data;
                if (!d) return '';
                return [d.fund_name || '', 'AUM: ' + (d.aum_fmt || ''), 'Issuer: ' + (d.issuer || ''), d.is_rex ? 'REX Product' : ''];
              }
            }
          },
          legend: { display: false }
        }
      }
    });
  }
  {% endif %}
});
</script>
{% endblock %}
