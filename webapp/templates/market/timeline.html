{% set active_tab = 'timeline' %}
{% extends "market/base.html" %}

{% block title %}Filing History â€” REX Financial Intelligence Hub{% endblock %}

{% block market_content %}
<h2 class="section-title">Filing History</h2>
<p style="color:#64748B; font-size:0.85rem; margin-bottom:16px;">
  Complete SEC filing history per trust. A <span style="color:#059669;font-weight:600;">485BPOS</span> marks when funds became eligible to trade.
  A <span style="color:#D97706;font-weight:600;">485BXT</span> is an extension request pushing back the effective date.
</p>

<div class="timeline-controls" style="display:flex; align-items:center; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
  <select class="select-sm" style="min-width:240px;"
          onchange="if(this.value) window.location='/market/timeline?trust_id='+this.value">
    <option value="">Select a trust...</option>
    {% for trust in trusts %}
    <option value="{{ trust.id }}" {{ 'selected' if trust.id == trust_id else '' }}>{{ trust.name }}</option>
    {% endfor %}
  </select>
</div>

{% if selected_trust %}
<div style="display:flex; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
  <h3 style="font-size:1rem; font-weight:700; margin:0;">{{ selected_trust.name }}</h3>
  {% if timeline_items %}
  <div style="display:flex; gap:16px; font-size:0.78rem; flex-wrap:wrap;">
    {% set ns = namespace(bpos=0, bxt=0) %}
    {% for item in timeline_items %}
      {% set form = item.filing.form_type if item.filing.form_type is defined else item.filing.form %}
      {% if form == '485BPOS' %}{% set ns.bpos = ns.bpos + 1 %}{% endif %}
      {% if form == '485BXT' %}{% set ns.bxt = ns.bxt + 1 %}{% endif %}
    {% endfor %}
    <span style="color:#059669; font-weight:600;">
      &#9679; {{ ns.bpos }} BPOS (effective)
    </span>
    <span style="color:#D97706; font-weight:600;">
      &#9679; {{ ns.bxt }} BXT (extensions)
    </span>
    <span style="color:#94A3B8;">
      {{ timeline_items | length }} total filings shown
    </span>
  </div>
  {% endif %}
</div>

{% if timeline_items %}
<div class="timeline">
  {% for item in timeline_items %}
  {% set form = item.filing.form_type if item.filing.form_type is defined else item.filing.form %}
  {% set dot_color = '#059669' if form == '485BPOS' else '#D97706' if form == '485BXT' else '#94A3B8' %}
  {% set eff_date = item.filing.effective_date if item.filing.effective_date is defined and item.filing.effective_date else item.effective_date if item.effective_date is defined else none %}
  <div class="timeline-entry {% if form == '485BPOS' %}entry-bpos{% elif form == '485BXT' %}entry-bxt{% else %}entry-other{% endif %}" style="--dot-color: {{ dot_color }};">
    <div class="timeline-date">
      {{ item.filing.filing_date.strftime('%b %d, %Y') if item.filing.filing_date else 'N/A' }}
    </div>
    <div class="timeline-content">
      <div class="timeline-form">
        <span class="badge badge-{{ 'primary' if form == '485BPOS' else 'warning' if form == '485BXT' else 'secondary' }}">
          {{ form }}
        </span>
        {% if eff_date %}
        <span class="timeline-effective">
          Effective: {{ eff_date.strftime('%b %d, %Y') }}
        </span>
        {% endif %}
      </div>
      {% if item.fund_count > 0 %}
      <div class="timeline-funds">
        {{ item.fund_count }} fund{{ '' if item.fund_count == 1 else 's' }}
      </div>
      {% endif %}
      {% if item.filing.accession_number %}
      <div class="timeline-accession">
        <a href="https://www.sec.gov/Archives/edgar/data/{{ selected_trust.cik }}/{{ item.filing.accession_number|replace('-','') }}/{{ item.filing.accession_number }}-index.htm"
           target="_blank" class="text-link" style="font-size:0.7rem;">{{ item.filing.accession_number }}</a>
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="alert alert-info">No 485 filings found for this trust.</div>
{% endif %}

{% elif trusts %}
<div class="alert alert-info">Select a trust above to view its filing history.</div>
{% endif %}
{% endblock %}

{% block market_scripts %}
<style>
.timeline-entry::before {
  background: var(--dot-color, var(--blue)) !important;
}
.entry-bpos::before {
  background: #059669 !important;
}
.entry-bxt::before {
  background: #D97706 !important;
}
.entry-other::before {
  background: #94A3B8 !important;
}
</style>
{% endblock %}
