{% set active_tab = 'compare' %}
{% extends "market/base.html" %}

{% block title %}Fund Comparison â€” REX Financial Intelligence Hub{% endblock %}

{% block market_content %}
<h2 class="section-title">Fund Comparison</h2>

<form class="timeline-controls" method="get" action="/market/compare">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <input type="text" name="tickers" class="select-sm" placeholder="Enter tickers (e.g. TQQQ,SQQQ,SPXL)" value="{{ tickers }}" style="min-width:280px;">
    <button type="submit" class="btn btn-primary" style="padding:6px 16px;font-size:0.85rem;">Compare</button>
  </div>
  <div style="font-size:0.75rem;color:#6B7280;margin-top:4px;">Up to 4 tickers, comma-separated</div>
</form>

{% if not available %}
<div class="alert alert-warning">Dashboard data file not found. Place <code>The Dashboard.xlsx</code> in <code>data/DASHBOARD/</code>.</div>
{% elif ticker_list and fund_data %}
<div class="table-responsive" style="margin-top:20px;">
  <table class="data-table">
    <thead>
      <tr>
        <th>Metric</th>
        {% for fund in fund_data %}
        <th>{{ fund.ticker }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Fund Name</strong></td>
        {% for fund in fund_data %}
        <td>{{ fund.row.get('fund_name', 'N/A') }}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>Issuer</strong></td>
        {% for fund in fund_data %}
        <td>{{ fund.row.get('issuer_display', 'N/A') }}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>Category</strong></td>
        {% for fund in fund_data %}
        <td>{{ fund.row.get('category_display', 'N/A') }}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>AUM</strong></td>
        {% for fund in fund_data %}
        {% set aum = fund.row.get('t_w4.aum') %}
        <td class="num-cell">{% if aum is not none and aum == aum %}${{ '{:,.0f}'.format(aum) }}M{% else %}N/A{% endif %}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>Expense Ratio</strong></td>
        {% for fund in fund_data %}
        {% set er = fund.row.get('t_w2.expense_ratio') %}
        <td class="num-cell">{% if er is not none and er == er %}{{ '{:.2f}'.format(er) }}%{% else %}N/A{% endif %}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>1W Return</strong></td>
        {% for fund in fund_data %}
        {% set ret = fund.row.get('t_w3.total_return_1week') %}
        <td class="num-cell {% if ret is not none and ret == ret %}{{ 'positive' if ret > 0 else 'negative' if ret < 0 else '' }}{% endif %}">
          {% if ret is not none and ret == ret %}{{ '{:+.2f}'.format(ret) }}%{% else %}N/A{% endif %}
        </td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>1M Return</strong></td>
        {% for fund in fund_data %}
        {% set ret = fund.row.get('t_w3.total_return_1month') %}
        <td class="num-cell {% if ret is not none and ret == ret %}{{ 'positive' if ret > 0 else 'negative' if ret < 0 else '' }}{% endif %}">
          {% if ret is not none and ret == ret %}{{ '{:+.2f}'.format(ret) }}%{% else %}N/A{% endif %}
        </td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>Annualized Yield</strong></td>
        {% for fund in fund_data %}
        {% set yld = fund.row.get('t_w3.annualized_yield') %}
        <td class="num-cell">{% if yld is not none and yld == yld %}{{ '{:.2f}'.format(yld) }}%{% else %}N/A{% endif %}</td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>1D Flow</strong></td>
        {% for fund in fund_data %}
        {% set flow = fund.row.get('t_w4.fund_flow_1day') %}
        <td class="num-cell {% if flow is not none and flow == flow %}{{ 'positive' if flow > 0 else 'negative' if flow < 0 else '' }}{% endif %}">
          {% if flow is not none and flow == flow %}${{ '{:,.1f}'.format(flow) }}M{% else %}N/A{% endif %}
        </td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>1W Flow</strong></td>
        {% for fund in fund_data %}
        {% set flow = fund.row.get('t_w4.fund_flow_1week') %}
        <td class="num-cell {% if flow is not none and flow == flow %}{{ 'positive' if flow > 0 else 'negative' if flow < 0 else '' }}{% endif %}">
          {% if flow is not none and flow == flow %}${{ '{:,.1f}'.format(flow) }}M{% else %}N/A{% endif %}
        </td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>1M Flow</strong></td>
        {% for fund in fund_data %}
        {% set flow = fund.row.get('t_w4.fund_flow_1month') %}
        <td class="num-cell {% if flow is not none and flow == flow %}{{ 'positive' if flow > 0 else 'negative' if flow < 0 else '' }}{% endif %}">
          {% if flow is not none and flow == flow %}${{ '{:,.1f}'.format(flow) }}M{% else %}N/A{% endif %}
        </td>
        {% endfor %}
      </tr>
      <tr>
        <td><strong>REX Product</strong></td>
        {% for fund in fund_data %}
        {% set is_rex = fund.row.get('is_rex') %}
        <td>{% if is_rex %}Yes{% else %}No{% endif %}</td>
        {% endfor %}
      </tr>
    </tbody>
  </table>
</div>
{% elif ticker_list %}
<div class="alert alert-info" style="margin-top:20px;">No matching funds found for: {{ ticker_list|join(', ') }}</div>
{% elif available %}
<div class="alert alert-info">Enter ticker symbols above to compare funds side by side.</div>
{% endif %}

{% endblock %}

{% block market_scripts %}
{% endblock %}
