{% set active_tab = 'rex' %}
{% extends "market/base.html" %}

{% block title %}REX View â€” REX Financial Intelligence Hub{% endblock %}

{% block market_content %}
{% if summary %}

{# -- Filter Bar -- #}
<div class="filter-bar" style="display:flex; gap:12px; margin-bottom:20px; align-items:center; flex-wrap:wrap;">
  <div style="display:flex; gap:8px; align-items:center;">
    <span style="font-size:0.72rem; color:var(--gray-500); font-weight:600; text-transform:uppercase;">Structure:</span>
    {% set fs_list = fund_structure.split(',') if fund_structure and fund_structure != 'all' else [] %}
    <button class="pill {% if 'ETF' in fs_list and 'ETN' not in fs_list %}active{% elif not fs_list %}{% endif %}"
            onclick="toggleFundStructure('ETF')">ETF</button>
    <button class="pill {% if 'ETN' in fs_list and 'ETF' not in fs_list %}active{% endif %}"
            onclick="toggleFundStructure('ETN')">ETN</button>
    <button class="pill {% if 'ETF' in fs_list and 'ETN' in fs_list %}active{% endif %}"
            onclick="toggleFundStructure('ETF,ETN')">Both</button>
  </div>
  {% if categories is defined %}
  <div style="display:flex; gap:8px; align-items:center;">
    <span style="font-size:0.72rem; color:var(--gray-500); font-weight:600; text-transform:uppercase;">Category:</span>
    <select onchange="window.location='?fund_structure={{ fund_structure|default('ETF')|urlencode }}&category='+encodeURIComponent(this.value)"
            class="select-sm" style="font-size:0.82rem; padding:4px 8px;">
      <option value="All" {% if not category or category == 'All' %}selected{% endif %}>All Categories</option>
      {% for c in categories %}
      <option value="{{ c }}" {% if category == c %}selected{% endif %}>
        {{ c | replace('Leverage & Inverse - ', 'L&I ') | replace('Income - ', 'Inc ') }}
      </option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
</div>

{# -- ETN AUM Disclaimer -- #}
{% if fund_structure and 'ETN' in fund_structure %}
<div style="font-size:0.72rem; color:var(--gray-500); margin-bottom:12px; font-style:italic;">
  Note: Bloomberg AUM for ETNs may not reflect outstanding shares.
</div>
{% endif %}

{# -- KPI Cards (5 cards - removed Avg Yield) -- #}
<div class="kpi-row" style="margin-bottom:24px;">
  <div class="kpi-card">
    <div class="kpi-label">Total REX AUM</div>
    <div class="kpi-value">{{ summary.kpis.aum_fmt }}</div>
    {% if summary.kpis.aum_mom_pct is defined %}
    <div style="font-size:0.7rem; margin-top:4px;" class="{{ 'positive' if summary.kpis.aum_mom_pct >= 0 else 'negative' }}">
      {{ '%+.1f'|format(summary.kpis.aum_mom_pct) }}% MoM
    </div>
    {% endif %}
    {% if summary.kpis.sparkline is defined %}
    <canvas id="sparkAum" width="120" height="30" style="margin-top:6px;"></canvas>
    {% endif %}
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Market Share</div>
    <div class="kpi-value">{{ '%.2f'|format(summary.kpis.market_share_pct|default(0)) }}%</div>
    {% if summary.kpis.market_share_mom_pct is defined %}
    <div style="font-size:0.7rem; margin-top:4px;" class="{{ 'positive' if summary.kpis.market_share_mom_pct >= 0 else 'negative' }}">
      {{ '%+.2f'|format(summary.kpis.market_share_mom_pct) }}pp MoM
    </div>
    {% endif %}
    {% if summary.kpis.share_sparkline is defined %}
    <canvas id="sparkShare" width="120" height="30" style="margin-top:6px;"></canvas>
    {% endif %}
  </div>
  <div class="kpi-card">
    <div class="kpi-label"># Products</div>
    <div class="kpi-value">{{ summary.kpis.num_products }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">1M Flows</div>
    <div class="kpi-value {{ 'positive' if summary.kpis.flow_1m > 0 else 'negative' if summary.kpis.flow_1m < 0 else '' }}">{{ summary.kpis.flow_1m_fmt }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">1M Market Growth</div>
    <div class="kpi-value {{ 'positive' if summary.kpis.mkt_appreciation_positive else 'negative' }}">{{ summary.kpis.mkt_appreciation_fmt }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Best Performer</div>
    {% if summary.kpis.best_performer %}
    <div class="kpi-value positive" style="font-size:var(--text-md);">{{ summary.kpis.best_performer.ticker }}</div>
    <div style="font-size:0.72rem;" class="positive">{{ summary.kpis.best_performer.return_1m_fmt }}</div>
    {% else %}
    <div class="kpi-value" style="font-size:var(--text-md);">--</div>
    {% endif %}
  </div>
</div>

{# -- Charts Row: Pie + Unified Chart -- #}
<div class="charts-row">
  <div class="chart-box">
    <h3>AUM by Suite</h3>
    <canvas id="suitesPieChart"></canvas>
  </div>
  <div class="chart-box" id="unifiedChartBox">
    {# -- Mode tabs -- #}
    <div style="display:flex; gap:4px; margin-bottom:12px; flex-wrap:wrap;">
      <button class="pill chart-mode-btn active" data-mode="aum" onclick="switchChartMode('aum')">AUM</button>
      <button class="pill chart-mode-btn" data-mode="flows" onclick="switchChartMode('flows')">Flows</button>
      <button class="pill chart-mode-btn" data-mode="volume" onclick="switchChartMode('volume')">Volume</button>
      <button class="pill chart-mode-btn" data-mode="spread" onclick="switchChartMode('spread')">Bid-Ask</button>
      <button class="pill chart-mode-btn" data-mode="appreciation" onclick="switchChartMode('appreciation')">Mkt Appreciation</button>
    </div>
    {# -- AUM sub-controls -- #}
    <div id="aumControls" style="margin-bottom:8px;">
      <label style="font-size:0.78rem; cursor:pointer; color:var(--gray-500);">
        <input type="checkbox" id="showSuiteBreakdown" onchange="switchChartMode('aum')"> Show Suite Breakdown
      </label>
    </div>
    {# -- Flow sub-controls -- #}
    <div id="flowControls" style="display:none; margin-bottom:8px;">
      <div style="display:flex; gap:4px;">
        {% for period in ['1w','1m','3m','6m','ytd','1y'] %}
        <button class="pill rex-flow-btn {% if loop.first %}active{% endif %}"
                data-period="{{ period }}" onclick="showRexFlowPeriod('{{ period }}')">
          {{ period.upper() }}
        </button>
        {% endfor %}
      </div>
    </div>
    <canvas id="unifiedChart" height="200"></canvas>
  </div>
</div>

{# -- Best/Worst Performance with Metric Selector -- #}
{% if summary.best5 or summary.worst5 %}
<div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
  <h2 class="section-title" style="border:none; margin:0; padding:0;">Performance</h2>
  <select id="perfMetricSelector" class="select-sm" style="font-size:0.82rem; padding:4px 8px;"
          onchange="switchPerfMetric(this.value)">
    <option value="return_1m" selected>1M Return</option>
    <option value="return_1w">1W Return</option>
    <option value="flow_1w">1W Flow</option>
    <option value="flow_1m">1M Flow</option>
    <option value="flow_3m">3M Flow</option>
    <option value="flow_6m">6M Flow</option>
    <option value="flow_ytd">YTD Flow</option>
    <option value="flow_1y">1Y Flow</option>
    <option value="yield">Annualized Yield</option>
  </select>
</div>
<div class="charts-row" style="margin-bottom:24px;">
  <div class="chart-box">
    <h3 id="best5Title">Best 5 by 1M Return</h3>
    <table class="data-table" style="font-size:0.82rem;">
      <thead><tr><th>Ticker</th><th>Fund Name</th><th style="text-align:center;" id="best5MetricHeader">1M Return</th></tr></thead>
      <tbody id="best5Body">
        {% for p in summary.best5 %}
        <tr>
          <td class="ticker-col">{{ p.ticker }}</td>
          <td style="word-wrap:break-word; white-space:normal; min-width:180px;">{{ p.fund_name }}</td>
          <td class="num-cell positive" style="text-align:center;">{{ p.return_1m_fmt }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="chart-box">
    <h3 id="worst5Title">Worst 5 by 1M Return</h3>
    <table class="data-table" style="font-size:0.82rem;">
      <thead><tr><th>Ticker</th><th>Fund Name</th><th style="text-align:center;" id="worst5MetricHeader">1M Return</th></tr></thead>
      <tbody id="worst5Body">
        {% for p in summary.worst5 %}
        <tr>
          <td class="ticker-col">{{ p.ticker }}</td>
          <td style="word-wrap:break-word; white-space:normal; min-width:180px;">{{ p.fund_name }}</td>
          <td class="num-cell negative" style="text-align:center;">{{ p.return_1m_fmt }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{# -- Suite Summary Table with Collapsible Products -- #}
<h2 class="section-title">REX Suites</h2>

<div class="table-responsive">
<table class="data-table suite-table" id="suiteTable">
  <thead>
    <tr>
      <th class="sortable" onclick="sortTable('suiteTable', 0)">Suite</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 1)">AUM</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 2)">1W Flow</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 3)">1M Flow</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 4)">Mkt Appr</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 5)">Avg Vol</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 6)">Avg Spread</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 7)">Mkt Share</th>
      <th class="sortable" style="text-align:center;" onclick="sortTable('suiteTable', 8)"># Funds</th>
      <th style="text-align:center;">Top Mover</th>
    </tr>
  </thead>
  <tbody>
    {% for suite in summary.suites %}
    <tr class="suite-parent-row" onclick="toggleSuiteProducts('suite{{ loop.index }}')" style="cursor:pointer;">
      <td>
        <span style="font-weight:500; color:var(--blue);" title="{{ suite.name }}">
          <span class="expand-icon" id="suite{{ loop.index }}Icon" style="font-size:0.7rem; margin-right:4px;">&#9654;</span>
          {{ suite.rex_name if suite.rex_name else suite.short_name }}
        </span>
      </td>
      <td class="num-cell" style="text-align:center;" data-sort="{{ suite.kpis.total_aum|default(0) }}">
        {{ suite.kpis.aum_fmt }}
        {% if suite.aum_mom_pct is defined and suite.aum_mom_pct != 0 %}
        <div style="font-size:0.65rem;" class="{{ 'positive' if suite.aum_mom_pct >= 0 else 'negative' }}">{{ '%+.1f'|format(suite.aum_mom_pct) }}%</div>
        {% endif %}
      </td>
      <td class="num-cell {{ 'positive' if suite.kpis.flow_1w > 0 else 'negative' if suite.kpis.flow_1w < 0 else '' }}" style="text-align:center;" data-sort="{{ suite.kpis.flow_1w|default(0) }}">{{ suite.kpis.flow_1w_fmt }}</td>
      <td class="num-cell {{ 'positive' if suite.kpis.flow_1m > 0 else 'negative' if suite.kpis.flow_1m < 0 else '' }}" style="text-align:center;" data-sort="{{ suite.kpis.flow_1m|default(0) }}">{{ suite.kpis.flow_1m_fmt }}</td>
      <td class="num-cell {{ 'positive' if suite.kpis.mkt_appreciation_positive else 'negative' }}" style="text-align:center;" data-sort="{{ suite.kpis.mkt_appreciation|default(0) }}">{{ suite.kpis.mkt_appreciation_fmt }}</td>
      <td class="num-cell" style="text-align:center;" data-sort="{{ suite.kpis.volume|default(0) }}">{{ suite.kpis.volume_fmt }}</td>
      <td class="num-cell" style="text-align:center;" data-sort="{{ suite.kpis.avg_spread|default(0) }}">{{ suite.kpis.avg_spread_fmt }}</td>
      <td class="num-cell" style="text-align:center;" data-sort="{{ suite.market_share|default(0) }}">{{ suite.market_share }}%</td>
      <td class="num-cell" style="text-align:center;" data-sort="{{ suite.kpis.num_products|default(0) }}">{{ suite.kpis.num_products }}</td>
      <td class="movers-cell" style="text-align:center;">{% for m in suite.top_movers[:1] %}<span class="{{ 'positive' if m.flow_raw > 0 else 'negative' if m.flow_raw < 0 else '' }}">{{ m.ticker }} {{ m.flow }}</span>{% endfor %}</td>
    </tr>
    {# Collapsible product rows for this suite #}
    <tr id="suite{{ loop.index }}" style="display:none;">
      <td colspan="10" style="padding:0;">
        <table class="data-table" style="font-size:0.78rem; margin:0; border:none;">
          <thead>
            <tr style="background:var(--surface-2, #f1f5f9);">
              <th style="padding:4px 8px;">Ticker</th>
              <th style="padding:4px 8px;">Fund Name</th>
              <th style="padding:4px 8px; text-align:center;">AUM</th>
              <th style="padding:4px 8px; text-align:center;">1W Flow</th>
              <th style="padding:4px 8px; text-align:center;">Expense Ratio</th>
            </tr>
          </thead>
          <tbody>
            {% for p in suite.products %}
            <tr>
              <td class="ticker-col" style="padding:3px 8px;">{{ p.ticker }}</td>
              <td class="name-cell" style="padding:3px 8px; max-width:220px;" title="{{ p.fund_name }}">{{ p.fund_name|truncate(35, true) }}</td>
              <td class="num-cell" style="padding:3px 8px; text-align:center;">{{ p.aum_fmt }}</td>
              <td class="num-cell" style="padding:3px 8px; text-align:center;">{{ p.flow_1w_fmt }}</td>
              <td class="num-cell" style="padding:3px 8px; text-align:center;">{{ p.expense_ratio_fmt or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% else %}
<div class="alert alert-warning">No REX data available.</div>
{% endif %}
{% endblock %}

{% block market_scripts %}
<script>
// Fund structure toggle (multi-select)
function toggleFundStructure(val) {
  var params = new URLSearchParams(location.search);
  params.set('fund_structure', val);
  // Preserve category
  if (!params.has('category')) params.set('category', 'All');
  location.search = params.toString();
}

// Collapsible suite products
function toggleSuiteProducts(id) {
  var row = document.getElementById(id);
  var icon = document.getElementById(id + 'Icon');
  if (!row) return;
  if (row.style.display === 'none') {
    row.style.display = '';
    if (icon) icon.innerHTML = '&#9660;';
  } else {
    row.style.display = 'none';
    if (icon) icon.innerHTML = '&#9654;';
  }
}

// Performance metric switching
var _perfData = {{ summary.perf_metrics|tojson if summary and summary.perf_metrics is defined else '{}' }};

function switchPerfMetric(metric) {
  var data = _perfData[metric];
  if (!data) return;

  var labels = {
    'return_1m': '1M Return', 'return_1w': '1W Return',
    'flow_1w': '1W Flow', 'flow_1m': '1M Flow', 'flow_3m': '3M Flow',
    'flow_6m': '6M Flow', 'flow_ytd': 'YTD Flow', 'flow_1y': '1Y Flow',
    'yield': 'Annualized Yield'
  };
  var label = labels[metric] || metric;

  document.getElementById('best5Title').textContent = 'Best 5 by ' + label;
  document.getElementById('worst5Title').textContent = 'Worst 5 by ' + label;
  document.getElementById('best5MetricHeader').textContent = label;
  document.getElementById('worst5MetricHeader').textContent = label;

  function renderRows(tbodyId, items, positive) {
    var tbody = document.getElementById(tbodyId);
    if (!tbody || !items) return;
    var html = '';
    items.forEach(function(p) {
      var cls = positive ? 'positive' : 'negative';
      html += '<tr><td class="ticker-col">' + (p.ticker||'') + '</td>';
      html += '<td style="word-wrap:break-word;white-space:normal;min-width:180px;">' + (p.fund_name||'') + '</td>';
      html += '<td class="num-cell ' + cls + '" style="text-align:center;">' + (p.value_fmt||'') + '</td></tr>';
    });
    tbody.innerHTML = html;
  }

  renderRows('best5Body', data.best5, true);
  renderRows('worst5Body', data.worst5, false);
}

document.addEventListener('DOMContentLoaded', function() {
  {% if summary %}

  {# -- Mini sparklines -- #}
  function miniSparkline(canvasId, data, color) {
    var ctx = document.getElementById(canvasId);
    if (!ctx || !data || data.length === 0) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(function(_, i) { return ''; }),
        datasets: [{
          data: data,
          borderColor: color || '#1E40AF',
          borderWidth: 1.5,
          pointRadius: 0,
          fill: false,
          tension: 0.3
        }]
      },
      options: {
        responsive: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: { x: { display: false }, y: { display: false } },
        animation: false
      }
    });
  }

  {% if summary.kpis.sparkline is defined %}
  miniSparkline('sparkAum', {{ summary.kpis.sparkline|tojson }}, '#1E40AF');
  {% endif %}
  {% if summary.kpis.share_sparkline is defined %}
  miniSparkline('sparkShare', {{ summary.kpis.share_sparkline|tojson }}, '#059669');
  {% endif %}

  {# -- Pie chart -- #}
  var pieData = {{ summary.pie_data|tojson }};
  var pieCtx = document.getElementById('suitesPieChart');
  if (pieCtx && pieData.values.length > 0) {
    new Chart(pieCtx, {
      type: 'doughnut',
      plugins: [ChartDataLabels],
      data: {
        labels: pieData.labels,
        datasets: [{
          data: pieData.values,
          backgroundColor: ['#1E40AF','#3B82F6','#0EA5E9','#6366F1','#8B5CF6','#A855F7','#EC4899','#F43F5E','#F97316','#EAB308','#22C55E','#14B8A6'].slice(0, pieData.values.length),
          borderWidth: 2,
          borderColor: RexTheme.isDark() ? '#1e293b' : '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          datalabels: {
            color: function() { return RexTheme.isDark() ? '#ffffff' : '#1E293B'; },
            font: { weight: 'bold', size: 12 },
            padding: 4,
            formatter: function(value, ctx) {
              var total = ctx.dataset.data.reduce(function(a,b){return a+b;},0);
              var pct = total > 0 ? (value/total*100).toFixed(1) : 0;
              var label = ctx.chart.data.labels[ctx.dataIndex];
              return pct > 3 ? label + '\n' + pct + '%' : pct + '%';
            },
            anchor: 'end', align: 'end', offset: 10, clamp: true,
            display: function(ctx) {
              var total = ctx.dataset.data.reduce(function(a,b){return a+b;},0);
              return total > 0 && ctx.dataset.data[ctx.dataIndex] / total > 0.02;
            }
          },
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                var total = ctx.dataset.data.reduce(function(a,b){return a+b;},0);
                var pct = total > 0 ? (ctx.parsed/total*100).toFixed(1) : 0;
                return ctx.label + ': $' + (ctx.parsed >= 1000 ? (ctx.parsed/1000).toFixed(1)+'B' : ctx.parsed.toFixed(1)+'M') + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    });
  }
  {% endif %}

  {% if trend %}
  {# -- Unified chart data -- #}
  var trendData = {{ trend|tojson }};
  {% if trend_all is defined and trend_all %}
  var trendAllData = {{ trend_all|tojson }};
  {% else %}
  var trendAllData = null;
  {% endif %}

  {% if summary and summary.chart_data is defined %}
  var chartData = {{ summary.chart_data|tojson }};
  {% else %}
  var chartData = {flow: {{ summary.flow_chart|tojson if summary and summary.flow_chart is defined else '{}' }}, volume: {}, spread: {}, appreciation: {}, suite_ts: {}};
  {% endif %}

  var _unifiedChart = null;
  var _currentChartMode = 'aum';
  var _currentFlowPeriod = '1w';

  function fmtMoney(val) {
    if (val === null || val === undefined || isNaN(val)) return '$0';
    var sign = val < 0 ? '-' : '';
    var abs = Math.abs(val);
    if (abs >= 1000) return sign + '$' + (abs / 1000).toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'B';
    if (abs >= 1) return sign + '$' + abs.toFixed(1).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'M';
    return sign + '$' + (abs * 1000).toFixed(0) + 'K';
  }
  function fmtFlow(val) { return (val >= 0 ? '+' : '') + fmtMoney(val); }
  function fmtVol(val) {
    if (val >= 1000000) return (val/1000000).toFixed(1) + 'M';
    if (val >= 1000) return Math.round(val/1000) + 'K';
    return Math.round(val).toString();
  }

  var SUITE_CHART_COLORS = ['#1E40AF','#3B82F6','#0EA5E9','#6366F1','#8B5CF6','#A855F7','#EC4899','#F43F5E','#F97316','#EAB308','#22C55E','#14B8A6'];

  window.switchChartMode = function(mode) {
    _currentChartMode = mode;
    // Update mode button states
    document.querySelectorAll('.chart-mode-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-mode') === mode);
    });
    // Show/hide sub-controls
    document.getElementById('aumControls').style.display = mode === 'aum' ? '' : 'none';
    document.getElementById('flowControls').style.display = mode === 'flows' ? '' : 'none';

    // Destroy existing chart
    if (_unifiedChart) { _unifiedChart.destroy(); _unifiedChart = null; }

    var ctx = document.getElementById('unifiedChart');
    if (!ctx) return;
    var isDark = RexTheme.isDark();
    var labelColor = isDark ? '#94a3b8' : '#6b7280';
    var gridColor = isDark ? 'rgba(255,255,255,0.08)' : '#f3f4f6';

    if (mode === 'aum') {
      // Line chart: AUM trend, optionally with suite breakdown
      var showBreakdown = document.getElementById('showSuiteBreakdown') && document.getElementById('showSuiteBreakdown').checked;
      var datasets = [];
      if (showBreakdown && chartData.suite_ts && chartData.suite_ts.suites) {
        var suiteNames = Object.keys(chartData.suite_ts.suites);
        suiteNames.forEach(function(name, i) {
          datasets.push({
            label: name,
            data: chartData.suite_ts.suites[name],
            borderColor: SUITE_CHART_COLORS[i % SUITE_CHART_COLORS.length],
            backgroundColor: SUITE_CHART_COLORS[i % SUITE_CHART_COLORS.length] + '20',
            fill: true,
            tension: 0.3,
            pointRadius: 1,
            borderWidth: 2
          });
        });
        var labels = chartData.suite_ts.labels || trendData.labels;
      } else {
        datasets.push({
          label: 'REX AUM',
          data: trendData.values,
          borderColor: '#1E40AF',
          backgroundColor: '#1E40AF20',
          fill: true,
          tension: 0.3,
          pointRadius: 2,
          borderWidth: 2
        });
        if (trendAllData) {
          datasets.unshift({
            label: 'Total REX AUM',
            data: trendAllData.values,
            borderColor: '#93C5FD',
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.3,
            pointRadius: 2,
            borderWidth: 2
          });
          datasets[1].label = 'Category AUM';
        }
        var labels = trendData.labels;
      }
      _unifiedChart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true, maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 12, font: { size: 10 }, color: labelColor }, grid: { display: false } },
            y: { ticks: { callback: function(v) { return fmtMoney(v); }, font: { size: 10 }, color: labelColor }, grid: { color: gridColor } }
          },
          plugins: {
            datalabels: { display: false },
            legend: { display: datasets.length > 1, labels: { font: { size: 11 }, usePointStyle: true, color: labelColor } },
            tooltip: { callbacks: { label: function(c) { return c.dataset.label + ': ' + fmtMoney(c.parsed.y); } } }
          }
        }
      });

    } else if (mode === 'flows') {
      showRexFlowPeriod(_currentFlowPeriod);

    } else if (mode === 'volume') {
      var vd = chartData.volume || {};
      _unifiedChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels: vd.suites || [],
          datasets: [{ data: vd.values || [], backgroundColor: '#3B82F6', borderRadius: 3 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: true,
          layout: { padding: { right: 80 } },
          scales: {
            x: { display: false, grace: '15%' },
            y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(c) { return fmtVol(c.parsed.x); } } },
            datalabels: {
              anchor: 'end', align: 'right',
              color: isDark ? '#e2e8f0' : '#1E293B',
              font: { size: 11, weight: '600' },
              formatter: function(v) { return fmtVol(v); },
              clip: false
            }
          }
        }
      });

    } else if (mode === 'spread') {
      var sd = chartData.spread || {};
      _unifiedChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels: sd.suites || [],
          datasets: [{ data: sd.values || [], backgroundColor: '#6366F1', borderRadius: 3 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: true,
          layout: { padding: { right: 80 } },
          scales: {
            x: { display: false, grace: '15%' },
            y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(c) { return '$' + c.parsed.x.toFixed(4); } } },
            datalabels: {
              anchor: 'end', align: 'right',
              color: isDark ? '#e2e8f0' : '#1E293B',
              font: { size: 11, weight: '600' },
              formatter: function(v) { return '$' + v.toFixed(4); },
              clip: false
            }
          }
        }
      });

    } else if (mode === 'appreciation') {
      var ad = chartData.appreciation || {};
      var vals = ad.values || [];
      var colors = vals.map(function(v) { return v >= 0 ? '#059669' : '#DC2626'; });
      _unifiedChart = new Chart(ctx, {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels: ad.suites || [],
          datasets: [{ data: vals, backgroundColor: colors, borderRadius: 3 }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: true,
          layout: { padding: { left: 10, right: 100 } },
          scales: {
            x: { display: false, grace: '20%' },
            y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: function(c) { return fmtFlow(c.parsed.x); } } },
            datalabels: {
              anchor: 'end',
              align: function(c) { return c.dataset.data[c.dataIndex] >= 0 ? 'right' : 'left'; },
              color: isDark ? '#e2e8f0' : '#1E293B',
              font: { size: 11, weight: '600' },
              formatter: function(v) { return v === 0 ? '' : fmtFlow(v); },
              clip: false
            }
          }
        }
      });
    }
  };

  window.showRexFlowPeriod = function(period) {
    _currentFlowPeriod = period;
    document.querySelectorAll('.rex-flow-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-period') === period);
    });
    var flowData = chartData.flow || {};
    var key = 'flow_' + period;
    var values = flowData[key];
    if (!values) return;
    var colors = values.map(function(v) { return v >= 0 ? '#059669' : '#DC2626'; });
    var isDark = RexTheme.isDark();
    var labelColor = isDark ? '#94a3b8' : '#374151';
    if (_unifiedChart) { _unifiedChart.destroy(); _unifiedChart = null; }
    _unifiedChart = new Chart(document.getElementById('unifiedChart').getContext('2d'), {
      type: 'bar',
      plugins: [ChartDataLabels],
      data: {
        labels: flowData.suites,
        datasets: [{ label: 'Flow $M', data: values, backgroundColor: colors }]
      },
      options: {
        indexAxis: 'y',
        layout: { padding: { left: 10, right: 100 } },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: function(ctx) {
            return fmtFlow(ctx.parsed.x);
          }}},
          datalabels: {
            anchor: 'end',
            align: function(ctx) { return ctx.dataset.data[ctx.dataIndex] >= 0 ? 'right' : 'left'; },
            color: isDark ? '#e2e8f0' : '#1E293B',
            font: { size: 11, weight: '600' },
            formatter: function(value) { return value === 0 ? '' : fmtFlow(value); },
            clip: false
          }
        },
        scales: {
          x: { display: false, grace: '20%' },
          y: { ticks: { font: { size: 11, weight: '600' }, color: labelColor }, grid: { display: false } }
        }
      }
    });
  };

  // Initialize with AUM mode
  switchChartMode('aum');
  {% endif %}
});
</script>
{% endblock %}
