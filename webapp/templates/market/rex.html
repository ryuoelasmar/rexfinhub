{% set active_tab = 'rex' %}
{% extends "market/base.html" %}

{% block title %}REX View — REX Financial Intelligence Hub{% endblock %}

{% block market_content %}
{% if summary %}

{# KPI Cards #}
{% with kpis=summary.kpis, prefix='rex-' %}
{% include "market/_kpi_cards.html" %}
{% endwith %}

{# ETF/ETN Filter Toggle #}
{% if fund_structure is defined %}
<div class="filter-bar" style="display:flex; gap:8px; margin-bottom:16px; align-items:center;">
  <span style="font-size:0.75rem; color:#94A3B8; font-weight:600; text-transform:uppercase;">Structure:</span>
  <a href="?fund_structure=all"
     class="pill {% if not fund_structure or fund_structure == 'all' %}active{% endif %}">All</a>
  <a href="?fund_structure=ETF"
     class="pill {% if fund_structure == 'ETF' %}active{% endif %}">ETF</a>
  <a href="?fund_structure=ETN"
     class="pill {% if fund_structure == 'ETN' %}active{% endif %}">ETN</a>
</div>
{% else %}
<div class="product-type-filter">
  <a href="/market/rex?product_type=All" class="filter-btn {{ 'active' if product_type == 'All' else '' }}">All</a>
  <a href="/market/rex?product_type=ETF" class="filter-btn {{ 'active' if product_type == 'ETF' else '' }}">ETF</a>
  <a href="/market/rex?product_type=ETN" class="filter-btn {{ 'active' if product_type == 'ETN' else '' }}">ETN</a>
</div>
{% endif %}

{# Charts Row #}
<div class="charts-row">
  <div class="chart-box">
    <h3>AUM by Suite</h3>
    <canvas id="suitesPieChart"></canvas>
    <table class="data-table" style="margin-top:12px; font-size:0.8rem;">
      <thead><tr><th>Suite</th><th>AUM</th><th>% Share</th><th>Products</th></tr></thead>
      <tbody>
        {% for suite in summary.suites %}
        <tr>
          <td>{{ suite.rex_name if suite.rex_name else suite.short_name }}</td>
          <td class="text-mono">{{ suite.kpis.aum_fmt }}</td>
          <td class="text-mono">{{ "%.1f%%"|format(suite.market_share) if suite.market_share else "—" }}</td>
          <td>{{ suite.kpis.num_products }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="chart-box">
    <h3>Total REX AUM Trend</h3>
    <canvas id="rexTrendChart"></canvas>
  </div>
</div>

{# Suite Cards #}
<h2 class="section-title">REX Suites</h2>

<div class="table-responsive">
<table class="data-table suite-table" id="suiteTable">
  <thead>
    <tr>
      <th>Suite</th>
      <th class="sortable" onclick="sortTable('suiteTable', 1)">AUM</th>
      <th class="sortable" onclick="sortTable('suiteTable', 2)">1W Flow</th>
      <th class="sortable" onclick="sortTable('suiteTable', 3)">1M Flow</th>
      <th class="sortable" onclick="sortTable('suiteTable', 4)">Mkt Share</th>
      <th class="sortable" onclick="sortTable('suiteTable', 5)"># Funds</th>
      <th>Top Mover</th>
    </tr>
  </thead>
  <tbody>
    {% for suite in summary.suites %}
    <tr class="suite-row" data-suite="{{ suite.name }}"
        onclick="toggleSuiteProducts('{{ suite.name | replace(' ', '-') | replace('/', '-') | lower }}')"
        style="cursor:pointer;">
      <td>
        <span class="expand-icon" id="expand-{{ loop.index }}">&#9654;</span>
        <a href="/market/category?cats={{ suite.name|urlencode }}" class="text-link" onclick="event.stopPropagation()" title="{{ suite.name }}">
          {{ suite.rex_name if suite.rex_name else suite.short_name }}
        </a>
      </td>
      <td class="num-cell" data-sort="{{ suite.kpis.total_aum|default(0) }}">{{ suite.kpis.aum_fmt }}</td>
      <td class="num-cell {{ 'positive' if suite.kpis.flow_1w > 0 else 'negative' if suite.kpis.flow_1w < 0 else '' }}" data-sort="{{ suite.kpis.flow_1w|default(0) }}">{{ suite.kpis.flow_1w_fmt }}</td>
      <td class="num-cell {{ 'positive' if suite.kpis.flow_1m > 0 else 'negative' if suite.kpis.flow_1m < 0 else '' }}" data-sort="{{ suite.kpis.flow_1m|default(0) }}">{{ suite.kpis.flow_1m_fmt }}</td>
      <td class="num-cell" data-sort="{{ suite.market_share|default(0) }}">{{ suite.market_share }}%</td>
      <td class="num-cell" data-sort="{{ suite.kpis.num_products|default(0) }}">{{ suite.kpis.num_products }}</td>
      <td class="movers-cell">{% for m in suite.top_movers[:1] %}<span class="{{ 'positive' if m.flow_raw > 0 else 'negative' if m.flow_raw < 0 else '' }}">{{ m.ticker }} {{ m.flow }}</span>{% endfor %}</td>
    </tr>
    <tr class="suite-products-row" id="suite-products-{{ suite.name | replace(' ', '-') | replace('/', '-') | lower }}"
        style="display:none;">
      <td colspan="7" style="padding:0; background:#F8FAFC;">
        <table class="data-table" style="margin:0; border:none; border-radius:0;">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Fund Name</th>
              <th>AUM</th>
              <th>1W Flow</th>
              <th>Exp Ratio</th>
              <th>REX</th>
            </tr>
          </thead>
          <tbody>
            {% for p in suite.products %}
            <tr class="{{ 'rex-highlight' if p.is_rex else '' }}">
              <td class="text-mono">{{ p.ticker }}</td>
              <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ p.fund_name }}</td>
              <td class="text-mono">{{ p.aum_fmt }}</td>
              <td class="text-mono {{ 'flow-positive' if p.flow_1w_fmt.startswith('+') else 'flow-negative' if p.flow_1w_fmt.startswith('-') else '' }}">{{ p.flow_1w_fmt }}</td>
              <td class="text-mono">{{ p.expense_ratio_fmt }}</td>
              <td>{% if p.is_rex %}<span style="color:#1E40AF;font-weight:700;">REX</span>{% endif %}</td>
            </tr>
            {% else %}
            <tr><td colspan="6" style="text-align:center;color:#94A3B8;padding:12px;">No products found</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% else %}
<div class="alert alert-warning">No REX data available.</div>
{% endif %}
{% endblock %}

{% block market_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if summary %}
  // Pie chart - AUM by suite (register datalabels inline, not globally)
  var pieData = {{ summary.pie_data|tojson }};
  var pieCtx = document.getElementById('suitesPieChart');
  if (pieCtx) {
    new Chart(pieCtx, {
      type: 'doughnut',
      plugins: [ChartDataLabels],
      data: {
        labels: pieData.labels.map(function(l) {
          return l.replace('Leverage & Inverse - ', 'L&I ')
                  .replace('Income - ', 'Inc ')
                  .replace('Index/Basket/ETF Based', 'Index/ETF')
                  .replace('Single Stock', 'Single');
        }),
        datasets: [{
          data: pieData.values,
          backgroundColor: ['#1E40AF','#3B82F6','#0EA5E9','#6366F1','#8B5CF6','#A855F7','#EC4899','#F43F5E','#F97316','#EAB308','#22C55E','#14B8A6'].slice(0, pieData.values.length),
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          datalabels: {
            color: '#fff',
            font: { weight: 'bold', size: 11 },
            formatter: function(value, ctx) {
              var total = ctx.dataset.data.reduce(function(a,b){return a+b;},0);
              var pct = total > 0 ? (value/total*100).toFixed(1) : 0;
              var label = ctx.chart.data.labels[ctx.dataIndex];
              return pct > 3 ? label + '\n' + pct + '%' : pct + '%';
            },
            anchor: 'center',
            align: 'center',
            display: function(ctx) {
              var total = ctx.dataset.data.reduce(function(a,b){return a+b;},0);
              return total > 0 && ctx.dataset.data[ctx.dataIndex] / total > 0.02;
            }
          },
          legend: {
            position: 'bottom',
            labels: { boxWidth: 12, font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                var total = ctx.dataset.data.reduce(function(a,b){return a+b;},0);
                var pct = total > 0 ? (ctx.parsed/total*100).toFixed(1) : 0;
                return ctx.label + ': $' + (ctx.parsed >= 1000 ? (ctx.parsed/1000).toFixed(1)+'B' : ctx.parsed.toFixed(1)+'M') + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    });
  }
  {% endif %}

  {% if trend %}
  // Line chart - REX AUM trend (no datalabels)
  var trendData = {{ trend|tojson }};
  MarketCharts.renderLineChart('rexTrendChart', trendData.labels, [
    {label: 'REX AUM', data: trendData.values, color: '#1E40AF'}
  ]);
  {% endif %}
});

function toggleSuiteProducts(key) {
  var row = document.getElementById('suite-products-' + key);
  var suiteRows = document.querySelectorAll('.suite-row');
  suiteRows.forEach(function(sr) {
    var k = sr.getAttribute('data-suite').replace(/ /g,'-').replace(/\//g,'-').toLowerCase();
    if (k === key) {
      var icon = sr.querySelector('.expand-icon');
      if (row.style.display === 'none' || row.style.display === '') {
        row.style.display = 'table-row';
        if (icon) icon.textContent = '\u25BC';
      } else {
        row.style.display = 'none';
        if (icon) icon.textContent = '\u25B6';
      }
    }
  });
}
</script>
{% endblock %}
