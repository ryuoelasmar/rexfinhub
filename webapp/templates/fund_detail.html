{% extends "base.html" %}
{% block title %}{{ fund.fund_name }} - ETP Filing Tracker{% endblock %}

{% block content %}
<div class="header">
  <div class="breadcrumb">
    <a href="/">Dashboard</a><span class="sep">/</span>
    {% if trust %}<a href="/trusts/{{ trust.slug }}">{{ trust.name }}</a><span class="sep">/</span>{% endif %}
    <span>{{ fund.fund_name }}</span>
  </div>
  <h1>{{ fund.fund_name }}</h1>
  <div class="date">
    {% if trust %}<a href="/trusts/{{ trust.slug }}">{{ trust.name }}</a> &middot; {% endif %}
    Series ID: {{ fund.series_id or 'N/A' }}
  </div>
</div>

<!-- Fund metadata -->
<div class="meta-grid">
  <div class="meta-item">
    <div class="meta-label">Status</div>
    <div class="meta-value"><span class="status-{{ fund.status|lower }}">{{ fund.status }}</span></div>
  </div>
  <div class="meta-item">
    <div class="meta-label">Ticker</div>
    <div class="meta-value ticker-col">{{ fund.ticker or 'N/A' }}</div>
  </div>
  <div class="meta-item">
    <div class="meta-label">Effective Date</div>
    <div class="meta-value">{{ fund.effective_date or 'N/A' }}</div>
  </div>
  <div class="meta-item">
    <div class="meta-label">Latest Form</div>
    <div class="meta-value">{{ fund.latest_form or 'N/A' }}</div>
  </div>
  <div class="meta-item">
    <div class="meta-label">Latest Filing Date</div>
    <div class="meta-value">{{ fund.latest_filing_date or 'N/A' }}</div>
  </div>
  {% if fund.status_reason %}
  <div class="meta-item" style="grid-column: span 2;">
    <div class="meta-label">Status Reason</div>
    <div class="meta-value" style="font-size:13px; font-weight:normal;">{{ fund.status_reason }}</div>
  </div>
  {% endif %}
  {% if fund.prospectus_link %}
  <div class="meta-item">
    <div class="meta-label">Prospectus</div>
    <div class="meta-value"><a href="{{ fund.prospectus_link }}" target="_blank">View on SEC</a></div>
  </div>
  {% endif %}
</div>

<!-- Name History -->
{% if names %}
<div class="section-header">
  <h2>Name History</h2>
  <span class="badge">{{ names|length }}</span>
</div>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>First Seen</th>
      <th>Last Seen</th>
      <th>Source Form</th>
      <th>Current</th>
    </tr>
  </thead>
  <tbody>
    {% for n in names %}
    <tr>
      <td>{{ n.name }}</td>
      <td>{{ n.first_seen_date or '' }}</td>
      <td>{{ n.last_seen_date or '' }}</td>
      <td>{{ n.source_form or '' }}</td>
      <td>{% if n.is_current %}<span style="color:var(--green)">Yes</span>{% endif %}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- Filing History -->
{% if extractions %}
<div class="section-header" style="margin-top:30px">
  <h2>Filing History</h2>
  <span class="badge">{{ extractions|length }}</span>
</div>

<!-- Form type filter pills -->
<div style="display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap;">
  <span class="form-pill active" onclick="filterFilings('ALL', this)">All</span>
  <span class="form-pill" onclick="filterFilings('485APOS', this)" style="border-color:#e67e22;">485APOS</span>
  <span class="form-pill" onclick="filterFilings('485BPOS', this)" style="border-color:#27ae60;">485BPOS</span>
  <span class="form-pill" onclick="filterFilings('485BXT', this)" style="border-color:#0984e3;">485BXT</span>
  <span class="form-pill" onclick="filterFilings('497', this)" style="border-color:#636e72;">497</span>
</div>

<table id="filing-table">
  <thead>
    <tr>
      <th>Filing Date</th>
      <th>Form Type</th>
      <th>Class Name</th>
      <th>Ticker</th>
      <th>Effective Date</th>
      <th>Confidence</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for row in extractions %}
    {% set e = row.FundExtraction %}
    {% set form_upper = row.form|upper %}
    <tr data-form="{{ row.form }}">
      <td>{{ row.filing_date or '' }}</td>
      <td>
        {% if form_upper.startswith('485B') and 'BXT' not in form_upper %}
        <span class="form-badge form-badge-effective">{{ row.form }}</span>
        <span style="font-size:10px; color:var(--gray); margin-left:4px;">Post-Effective</span>
        {% elif 'BXT' in form_upper %}
        <span class="form-badge form-badge-extension">{{ row.form }}</span>
        <span style="font-size:10px; color:var(--gray); margin-left:4px;">Extension</span>
        {% elif form_upper.startswith('485A') %}
        <span class="form-badge form-badge-initial">{{ row.form }}</span>
        <span style="font-size:10px; color:var(--gray); margin-left:4px;">Initial Filing</span>
        {% elif form_upper.startswith('497') %}
        <span class="form-badge form-badge-supplement">{{ row.form }}</span>
        <span style="font-size:10px; color:var(--gray); margin-left:4px;">Supplement</span>
        {% else %}
        <span class="form-badge">{{ row.form }}</span>
        {% endif %}
      </td>
      <td>{{ e.class_contract_name or '' }}</td>
      <td class="ticker-col">{{ e.class_symbol or '' }}</td>
      <td>{{ e.effective_date or '' }}</td>
      <td>
        {% if e.effective_date_confidence == 'HIGH' %}
        <span style="color:var(--green); font-size:12px;">HIGH</span>
        {% elif e.effective_date_confidence == 'MEDIUM' %}
        <span style="color:var(--orange); font-size:12px;">MED</span>
        {% elif e.effective_date_confidence %}
        <span style="color:var(--gray); font-size:12px;">{{ e.effective_date_confidence }}</span>
        {% endif %}
      </td>
      <td style="white-space:nowrap;">
        {% if row.primary_link %}
        <a href="{{ row.primary_link }}" target="_blank" style="font-size:12px;">View</a>
        {% endif %}
        {% if row.filing_id %}
        <a href="/analysis/filing/{{ row.filing_id }}" style="font-size:12px; margin-left:8px;">Analyze</a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function filterFilings(form, btn) {
  var rows = document.querySelectorAll('#filing-table tbody tr');
  rows.forEach(function(row) {
    if (form === 'ALL' || row.getAttribute('data-form').toUpperCase().indexOf(form) >= 0) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
  document.querySelectorAll('.form-pill').forEach(function(p) { p.classList.remove('active'); });
  btn.classList.add('active');
}
</script>
{% endblock %}
