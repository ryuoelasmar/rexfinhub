{% extends "base.html" %}
{% block title %}Downloads â€” REX Financial Intelligence Hub{% endblock %}

{% block content %}
<div class="header">
  <h1>Downloads</h1>
  <div class="date">Export data for offline analysis</div>
</div>

<!-- Section 1: Global Live Exports -->
<div class="section-header">
  <h2>Live Data Exports</h2>
</div>
<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:16px; margin-bottom:24px;">
  <div style="border:1px solid var(--border); border-radius:8px; padding:20px; background:var(--light);">
    <h3 style="margin:0 0 6px 0; font-size:16px;">All Funds</h3>
    <p style="font-size:13px; color:var(--gray); margin:0 0 12px 0;">Current fund status for all ~7,000 ETF funds across all trusts.</p>
    <a href="/downloads/export/funds" class="btn btn-primary btn-sm">Download CSV</a>
  </div>
  <div style="border:1px solid var(--border); border-radius:8px; padding:20px; background:var(--light);">
    <h3 style="margin:0 0 6px 0; font-size:16px;">All Filings</h3>
    <p style="font-size:13px; color:var(--gray); margin:0 0 12px 0;">Complete filing history with fund extractions across all trusts.</p>
    <a href="/downloads/export/filings" class="btn btn-primary btn-sm">Download CSV</a>
  </div>
</div>

<!-- Section 2: Per-Trust Data -->
{% if all_trusts %}
<div class="section-header">
  <h2>Per-Trust Data</h2>
  <span class="badge">{{ total_trust_count }} trusts</span>
</div>
<div class="filter-bar" style="margin-bottom:16px;">
  <input type="text" id="trustSearch" placeholder="Search trust name..." oninput="filterTrusts(this.value)" style="width:300px;">
  <span id="trustMatchCount" style="font-size:13px; color:var(--gray);"></span>
</div>
<div id="trustAccordion">
  {% for t in all_trusts %}
  <details class="trust-detail" data-name="{{ t.name|lower }}" style="border:1px solid var(--border); border-radius:8px; margin-bottom:8px; background:var(--light);">
    <summary style="padding:12px 16px; cursor:pointer; font-weight:600; font-size:14px;">
      {{ t.name }}
      {% if t.is_rex %}
      <span style="background:var(--navy); color:white; font-size:10px; padding:1px 6px; border-radius:8px; margin-left:6px;">[REX]</span>
      {% endif %}
    </summary>
    <div style="padding:8px 16px 16px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <a href="/downloads/export/trust/{{ t.id }}/filings" class="btn btn-sm">Fund Status CSV</a>
      </div>
      {% if trust_files_map.get(t.name) %}
      <div style="font-size:12px; color:var(--gray); margin-bottom:6px;">Pipeline files:</div>
      <table style="margin:0;">
        <thead>
          <tr>
            <th>File</th>
            <th>Size</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for f in trust_files_map[t.name] %}
          <tr>
            <td style="font-size:13px;">{{ f.name }}</td>
            <td style="color:var(--gray); font-size:13px;">{{ f.size }}</td>
            <td><a href="/downloads/file?path={{ f.path }}" class="btn btn-sm">Download</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
  </details>
  {% endfor %}
</div>
{% endif %}

<!-- Section 3: Other Files -->
{% if summary_files or digest_files %}
<div class="section-header" style="margin-top:24px;">
  <h2>Other Files</h2>
</div>

{% if summary_files %}
<h3 style="font-size:14px; margin-bottom:8px;">Summary Reports</h3>
<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Size</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for f in summary_files %}
    <tr>
      <td>{{ f.name }}</td>
      <td style="color:var(--gray); font-size:13px;">{{ f.size }}</td>
      <td><a href="/downloads/file?path={{ f.path }}" class="btn btn-sm">Download</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

{% if digest_files %}
<h3 style="font-size:14px; margin-bottom:8px; margin-top:16px;">Daily Digest</h3>
<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Size</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for f in digest_files %}
    <tr>
      <td>{{ f.name }}</td>
      <td style="color:var(--gray); font-size:13px;">{{ f.size }}</td>
      <td><a href="/downloads/file?path={{ f.path }}" class="btn btn-sm">Download</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
{% endif %}

{% if not summary_files and not digest_files and not all_trusts %}
<div style="text-align:center; padding:40px; color:var(--gray);">
  <p>No files available yet. Run the pipeline to generate output files.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function filterTrusts(q) {
  q = q.trim().toLowerCase();
  var details = document.querySelectorAll('.trust-detail');
  var shown = 0;
  var total = details.length;
  details.forEach(function(el) {
    if (!q || el.getAttribute('data-name').indexOf(q) !== -1) {
      el.style.display = '';
      shown++;
    } else {
      el.style.display = 'none';
    }
  });
  var countEl = document.getElementById('trustMatchCount');
  if (q) {
    countEl.textContent = shown + ' of ' + total + ' trusts';
  } else {
    countEl.textContent = '';
  }
}
</script>
{% endblock %}
