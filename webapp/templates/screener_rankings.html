{% extends "base.html" %}
{% block title %}Launch Screener - ETP Filing Tracker{% endblock %}

{% block content %}
<div class="header">
  <h1>Launch Screener</h1>
  <div class="date">
    {% if upload %}
      Data uploaded {{ upload.uploaded_at.strftime('%b %d, %Y %H:%M') }} |
      {{ total_screened | default(0) }} stocks screened |
      {{ launched_count | default(0) }} already launched (excluded) |
      {{ filed_count | default(0) }} have REX filings
    {% else %}
      {% if data_available is defined and data_available %}
        Bloomberg data found on disk. <a href="/admin/">Score it from the Admin panel</a> to view results.
      {% else %}
        No data loaded. Place Bloomberg .xlsx in data/SCREENER/ and score from the <a href="/admin/">Admin panel</a>.
      {% endif %}
    {% endif %}
  </div>
</div>

<!-- Sub-navigation -->
<div style="display:flex; gap:4px; margin-bottom:20px; border-bottom:2px solid var(--navy); padding-bottom:8px;">
  <a href="/screener/" class="pill{% if tab == 'opportunities' %} active{% endif %}">Screener</a>
  <a href="/screener/rex-funds" class="pill{% if tab == 'rex' %} active{% endif %}">REX Funds</a>
  <a href="/screener/evaluate" class="pill{% if tab == 'evaluate' %} active{% endif %}">Evaluate</a>
</div>

{% if all_opportunities or filed_only %}
<!-- Filter Bar -->
<div class="filter-bar">
  <form method="get" action="/screener/" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%;">
    <input type="text" name="q" value="{{ q }}" placeholder="Search ticker..." style="width:160px;">
    <select name="sector" style="padding:6px 12px; border:1px solid var(--border); border-radius:4px; font-size:13px;">
      <option value="">All Sectors</option>
      {% for s in sectors %}
      <option value="{{ s }}" {% if sector == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
    {% if q or sector %}
    <a href="/screener/" style="font-size:12px; color:var(--gray);">Clear</a>
    {% endif %}
  </form>
</div>

<!-- ==================== TABLE 1: TOP 50 ALL OPPORTUNITIES ==================== -->
<div class="section-header">
  <h2>Top 50 - All Opportunities</h2>
  <span class="badge">{{ all_opportunities | length }} shown</span>
</div>
<p style="font-size:12px; color:var(--gray); margin-bottom:12px;">
  Top opportunities by composite score. Excludes underliers where REX has already launched products.
  Green rows indicate REX has filed for this underlier.
</p>

<div class="table-scroll-wrap">
<table id="allOpportunitiesTable">
  <thead>
    <tr>
      <th style="width:40px;">#</th>
      <th onclick="sortTable('allOpportunitiesTable',1)">Ticker</th>
      <th onclick="sortTable('allOpportunitiesTable',2)">Sector</th>
      <th onclick="sortTable('allOpportunitiesTable',3)" style="text-align:right;">Score</th>
      <th onclick="sortTable('allOpportunitiesTable',4)" style="text-align:right;">Mkt Cap ($M)</th>
      <th onclick="sortTable('allOpportunitiesTable',5)" style="text-align:right;">OI %</th>
      <th>REX Filing</th>
    </tr>
  </thead>
  <tbody>
    {% for r in all_opportunities %}
    <tr {% if r.filing_status and r.filing_status.startswith('REX Filed') %}style="background:#e8f5e9;"{% endif %}>
      <td style="color:var(--gray); font-size:12px;">{{ loop.index }}</td>
      <td class="ticker-col">
        <a href="/screener/stock/{{ r.ticker }}">{{ r.ticker }}</a>
      </td>
      <td style="font-size:12px;">{{ r.sector if r.sector and r.sector != 'nan' else '-' }}</td>
      <td style="text-align:right;">
        <span style="display:inline-block; width:40px; text-align:right; font-weight:600;
          {% if r.composite_score >= 70 %}color:var(--green);
          {% elif r.composite_score >= 40 %}color:var(--orange);
          {% else %}color:var(--gray);{% endif %}">
          {{ "%.1f"|format(r.composite_score) }}
        </span>
        <div style="display:inline-block; width:60px; height:6px; background:#eee; border-radius:3px; vertical-align:middle; margin-left:4px;">
          <div style="width:{{ r.composite_score }}%; height:100%; border-radius:3px;
            {% if r.composite_score >= 70 %}background:var(--green);
            {% elif r.composite_score >= 40 %}background:var(--orange);
            {% else %}background:var(--gray);{% endif %}"></div>
        </div>
      </td>
      <td style="text-align:right; font-size:12px;">
        {% if r.mkt_cap %}{{ "{:,.0f}".format(r.mkt_cap) }}{% else %}-{% endif %}
      </td>
      <td style="text-align:right; font-size:12px;">
        {% if r.total_oi_pctl %}{{ "%.0f"|format(r.total_oi_pctl) }}{% else %}-{% endif %}
      </td>
      <td>
        {% if r.filing_status and r.filing_status != 'Not Filed' %}
        <span style="font-size:11px; padding:2px 8px; border-radius:10px; font-weight:600;
          {% if 'Effective' in r.filing_status %}background:#e8f5e9; color:var(--green);
          {% elif 'Pending' in r.filing_status %}background:#e3f2fd; color:var(--blue);
          {% elif 'Delayed' in r.filing_status %}background:#fff3e0; color:var(--orange);
          {% else %}background:var(--light); color:var(--gray);{% endif %}">
          {{ r.filing_status }}
        </span>
        {% else %}
        <span style="font-size:11px; color:var(--gray);">-</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<!-- ==================== TABLE 2: REX FILED - PENDING LAUNCH ==================== -->
{% if filed_only %}
<div class="section-header" style="margin-top:40px;">
  <h2>REX Filed - Pending Launch</h2>
  <span class="badge">{{ filed_only | length }} of {{ filed_count }} filed</span>
</div>
<p style="font-size:12px; color:var(--gray); margin-bottom:12px;">
  Only underliers where REX has filed (485APOS/485BPOS) but NOT yet launched.
  These are the launch candidates with active filings, ranked by composite score.
</p>

<div class="table-scroll-wrap">
<table id="filedOnlyTable">
  <thead>
    <tr>
      <th style="width:40px;">#</th>
      <th onclick="sortTable('filedOnlyTable',1)">Ticker</th>
      <th onclick="sortTable('filedOnlyTable',2)">Sector</th>
      <th onclick="sortTable('filedOnlyTable',3)" style="text-align:right;">Score</th>
      <th onclick="sortTable('filedOnlyTable',4)" style="text-align:right;">Mkt Cap ($M)</th>
      <th onclick="sortTable('filedOnlyTable',5)" style="text-align:right;">OI %</th>
      <th>REX Filing</th>
    </tr>
  </thead>
  <tbody>
    {% for r in filed_only %}
    <tr style="background:#e8f5e9;">
      <td style="color:var(--gray); font-size:12px;">{{ loop.index }}</td>
      <td class="ticker-col">
        <a href="/screener/stock/{{ r.ticker }}">{{ r.ticker }}</a>
      </td>
      <td style="font-size:12px;">{{ r.sector if r.sector and r.sector != 'nan' else '-' }}</td>
      <td style="text-align:right;">
        <span style="display:inline-block; width:40px; text-align:right; font-weight:600;
          {% if r.composite_score >= 70 %}color:var(--green);
          {% elif r.composite_score >= 40 %}color:var(--orange);
          {% else %}color:var(--gray);{% endif %}">
          {{ "%.1f"|format(r.composite_score) }}
        </span>
        <div style="display:inline-block; width:60px; height:6px; background:#eee; border-radius:3px; vertical-align:middle; margin-left:4px;">
          <div style="width:{{ r.composite_score }}%; height:100%; border-radius:3px;
            {% if r.composite_score >= 70 %}background:var(--green);
            {% elif r.composite_score >= 40 %}background:var(--orange);
            {% else %}background:var(--gray);{% endif %}"></div>
        </div>
      </td>
      <td style="text-align:right; font-size:12px;">
        {% if r.mkt_cap %}{{ "{:,.0f}".format(r.mkt_cap) }}{% else %}-{% endif %}
      </td>
      <td style="text-align:right; font-size:12px;">
        {% if r.total_oi_pctl %}{{ "%.0f"|format(r.total_oi_pctl) }}{% else %}-{% endif %}
      </td>
      <td>
        <span style="font-size:11px; padding:2px 8px; border-radius:10px; font-weight:600;
          {% if 'Effective' in r.filing_status %}background:#e8f5e9; color:var(--green);
          {% elif 'Pending' in r.filing_status %}background:#e3f2fd; color:var(--blue);
          {% elif 'Delayed' in r.filing_status %}background:#fff3e0; color:var(--orange);
          {% else %}background:var(--light); color:var(--gray);{% endif %}">
          {{ r.filing_status }}
        </span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endif %}

{% elif upload %}
<div class="what-changed">
  <h2>No results match your filters</h2>
  <p>Try broadening your search or <a href="/screener/">clearing filters</a>.</p>
</div>
{% endif %}

{% endblock %}
