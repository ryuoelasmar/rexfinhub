{% extends "base.html" %}
{% block title %}Filings - ETP Filing Tracker{% endblock %}

{% block content %}
<div class="header">
  <h1>Filing Search</h1>
  <div class="date">
    {{ total_all }} total filings tracked{% if q or form or trust_id or show_all %} &middot; {{ total }} matching{% endif %}
    {% if not show_all and not form and not q %}
    &middot; <span style="color:var(--gray);">Prospectus filings only</span>
    {% endif %}
  </div>
</div>

<!-- Filters -->
<form method="get" action="/filings/" style="margin-bottom:20px;">
  <div class="filter-bar">
    <input type="text" name="q" value="{{ q }}" placeholder="Search by trust, accession, form type...">
    <input type="text" name="form" value="{{ form }}" placeholder="Form filter (e.g. 485BPOS)" style="width:180px;">
    <select name="trust_id">
      <option value="0">All Trusts</option>
      {% for t in trusts %}
      <option value="{{ t.id }}" {% if trust_id == t.id %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary btn-sm">Search</button>
    {% if q or form or trust_id or show_all %}
    <a href="/filings/" style="font-size:12px; color:var(--gray); margin-left:4px;">Clear</a>
    {% endif %}
    {% if not show_all and not form and not q %}
    <a href="/filings/?show_all=true{% if trust_id %}&trust_id={{ trust_id }}{% endif %}" style="font-size:12px; color:var(--gray); margin-left:8px;">Show all form types</a>
    {% elif show_all %}
    <a href="/filings/{% if trust_id %}?trust_id={{ trust_id }}{% endif %}" style="font-size:12px; color:var(--gray); margin-left:8px;">Prospectus only</a>
    {% endif %}
  </div>
</form>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Form</th>
      <th>Trust</th>
      <th>Fund(s)</th>
      <th>Accession</th>
      <th>Doc</th>
      <th>AI</th>
    </tr>
  </thead>
  <tbody>
    {% for row in filings %}
    {% set f = row.Filing %}
    {% set form_upper = f.form|upper %}
    <tr>
      <td>{{ f.filing_date or '' }}</td>
      <td>
        {% if form_upper.startswith('485B') and 'BXT' not in form_upper %}
        <span class="form-badge form-badge-effective">{{ f.form }}</span>
        {% elif 'BXT' in form_upper %}
        <span class="form-badge form-badge-extension">{{ f.form }}</span>
        {% elif form_upper.startswith('485A') %}
        <span class="form-badge form-badge-initial">{{ f.form }}</span>
        {% elif form_upper.startswith('497') %}
        <span class="form-badge form-badge-supplement">{{ f.form }}</span>
        {% else %}
        <span class="form-badge">{{ f.form }}</span>
        {% endif %}
      </td>
      <td><a href="/trusts/{{ row.trust_slug }}">{{ row.trust_name }}</a></td>
      <td style="font-size:12px; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ row.fund_names or '' }}</td>
      <td class="accession-col">{{ f.accession_number }}</td>
      <td>
        {% if f.primary_link %}
        <a href="{{ f.primary_link }}" target="_blank">View</a>
        {% endif %}
      </td>
      <td><a href="/analysis/filing/{{ f.id }}" class="btn btn-sm" style="font-size:11px;">Analyze</a></td>
    </tr>
    {% endfor %}
    {% if not filings %}
    <tr><td colspan="7" class="empty-state">No filings found.</td></tr>
    {% endif %}
  </tbody>
</table>
{% endblock %}
