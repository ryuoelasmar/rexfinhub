{% extends "base.html" %}
{% block title %}REX Fund Portfolio - Launch Screener{% endblock %}

{% block content %}
<div class="header">
  <h1>REX Fund Portfolio</h1>
  <div class="date">
    {% if upload %}
      Data as of {{ upload.uploaded_at.strftime('%b %d, %Y') }}
    {% else %}
      No data loaded. Upload Bloomberg data from the <a href="/admin/">Admin panel</a>.
    {% endif %}
  </div>
</div>

<!-- Sub-navigation -->
<div style="display:flex; gap:4px; margin-bottom:20px; border-bottom:2px solid var(--navy); padding-bottom:8px;">
  <a href="/screener/" class="pill{% if tab == 'rankings' %} active{% endif %}">Rankings</a>
  <a href="/screener/rex-funds" class="pill{% if tab == 'rex' %} active{% endif %}">REX Funds</a>
</div>

{% if product_groups %}
<!-- KPI Row -->
<div class="kpi-row">
  <div class="kpi">
    <div class="num">${{ "{:,.0f}".format(kpis.total_aum) }}M</div>
    <div class="label">Total REX AUM</div>
  </div>
  <div class="kpi">
    <div class="num" style="{% if kpis.net_flow_1m >= 0 %}color:var(--green);{% else %}color:var(--red);{% endif %}">
      ${{ "{:,.0f}".format(kpis.net_flow_1m) }}M
    </div>
    <div class="label">Net Flows (1M)</div>
  </div>
  <div class="kpi">
    <div class="num" style="color:var(--green);">{{ kpis.best or '-' }}</div>
    <div class="label">Best Inflows{% if kpis.best_flow %} (${{ "{:,.0f}".format(kpis.best_flow) }}M){% endif %}</div>
  </div>
  <div class="kpi">
    <div class="num" style="color:var(--red);">{{ kpis.worst or '-' }}</div>
    <div class="label">Worst Outflows{% if kpis.worst_flow %} (${{ "{:,.0f}".format(kpis.worst_flow) }}M){% endif %}</div>
  </div>
</div>

<!-- Product Line Groups: T-REX, Microsectors, Other REX -->
{% for group_name in ["T-REX", "Microsectors", "Other REX"] %}
{% set funds = product_groups.get(group_name, []) %}
{% if funds %}
<div class="trust-block open" style="margin-bottom:16px;">
  <div class="trust-header" onclick="toggleTrust(this)">
    <h3>{{ group_name }} <span style="font-size:12px; color:var(--gray); font-weight:normal;">({{ funds|length }} funds, AUM: ${{ "{:,.0f}".format(funds|sum(attribute='aum')) }}M)</span></h3>
  </div>
  <div class="trust-body" style="display:block;">
    {% if group_name == "Microsectors" %}
    <div style="background:#fff3cd; border-left:4px solid #ffc107; padding:8px 12px; border-radius:0 6px 6px 0; margin-bottom:8px; font-size:12px; color:#856404;">
      <strong>Note:</strong> Microsectors AUM figures may be overstated as Bloomberg reports total issuance rather than outstanding amounts.
    </div>
    {% endif %}
    <div style="overflow-x:auto;">
    <table style="border-collapse:collapse; width:100%;">
      <thead>
        <tr>
          <th style="padding:8px 10px;">Ticker</th>
          <th style="padding:8px 10px;">Fund Name</th>
          <th style="padding:8px 10px;">Underlier</th>
          <th style="padding:8px 10px; text-align:right;">AUM ($M)</th>
          <th style="padding:8px 10px; text-align:right;">Flow 1M</th>
          <th style="padding:8px 10px; text-align:right;">Flow 3M</th>
          <th style="padding:8px 10px; text-align:right;">Flow YTD</th>
          <th style="padding:8px 10px; text-align:right;">Return YTD</th>
          <th style="padding:8px 10px; text-align:right;">Spread</th>
          <th style="padding:8px 10px; text-align:right;">Tracking Err</th>
        </tr>
      </thead>
      <tbody>
        {% for f in funds %}
        <tr>
          <td class="ticker-col" style="padding:6px 10px;">
            {% if f.underlier %}<a href="/screener/stock/{{ f.underlier }}">{{ f.ticker }}</a>{% else %}{{ f.ticker }}{% endif %}
          </td>
          <td style="padding:6px 10px; font-size:12px; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ f.fund_name }}</td>
          <td style="padding:6px 10px; font-size:12px; font-family:monospace;">{{ f.underlier or '-' }}</td>
          <td style="padding:6px 10px; text-align:right; font-weight:600;">{{ "{:,.1f}".format(f.aum) }}</td>
          <td style="padding:6px 10px; text-align:right; {% if f.flow_1m > 0 %}color:var(--green);{% elif f.flow_1m < 0 %}color:var(--red);{% endif %}">
            {{ "{:,.1f}".format(f.flow_1m) }}
          </td>
          <td style="padding:6px 10px; text-align:right; {% if f.flow_3m > 0 %}color:var(--green);{% elif f.flow_3m < 0 %}color:var(--red);{% endif %}">
            {{ "{:,.1f}".format(f.flow_3m) }}
          </td>
          <td style="padding:6px 10px; text-align:right; {% if f.flow_ytd > 0 %}color:var(--green);{% elif f.flow_ytd < 0 %}color:var(--red);{% endif %}">
            {{ "{:,.1f}".format(f.flow_ytd) }}
          </td>
          <td style="padding:6px 10px; text-align:right; {% if f.return_ytd > 0 %}color:var(--green);{% elif f.return_ytd < 0 %}color:var(--red);{% endif %}">
            {{ "%.1f"|format(f.return_ytd) }}%
          </td>
          <td style="padding:6px 10px; text-align:right; font-size:12px;">{% if f.spread %}{{ "%.2f"|format(f.spread) }}{% else %}-{% endif %}</td>
          <td style="padding:6px 10px; text-align:right; font-size:12px;">{% if f.tracking_error %}{{ "%.2f"|format(f.tracking_error) }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>
{% endif %}
{% endfor %}

{% else %}
<div class="what-changed">
  <h2>No REX fund data available</h2>
  <p>Upload Bloomberg data from the <a href="/admin/">Admin panel</a> to see REX fund performance.</p>
</div>
{% endif %}

{% endblock %}
